<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Security Test - Dog Bar</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background: #f5f5f5;
      }
      h1 {
        color: #333;
      }
      .test-section {
        background: white;
        padding: 20px;
        margin: 20px 0;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      button {
        background: #0ea5e9;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 16px;
        margin: 5px;
      }
      button:hover {
        background: #0284c7;
      }
      button:active {
        transform: scale(0.98);
      }
      #results {
        background: #1e1e1e;
        color: #d4d4d4;
        padding: 20px;
        border-radius: 6px;
        font-family: "Courier New", monospace;
        font-size: 14px;
        line-height: 1.6;
        white-space: pre-wrap;
        max-height: 600px;
        overflow-y: auto;
        margin-top: 20px;
      }
      .secure {
        color: #4ade80;
      }
      .vulnerable {
        color: #f87171;
      }
      .info {
        color: #60a5fa;
      }
      .warning {
        color: #fbbf24;
      }
    </style>
  </head>
  <body>
    <h1>üîí Dog Bar Security Test Suite</h1>

    <div class="test-section">
      <h2>üì¶ Storage Security Tests</h2>
      <p>Test if file uploads can be bypassed via direct API calls</p>
      <button onclick="testStorage()">Run Storage Tests</button>
    </div>

    <div class="test-section">
      <h2>üîê RLS Policy Tests</h2>
      <p>Test if database access is properly restricted</p>
      <button onclick="testRLS()">Run RLS Tests</button>
    </div>

    <div class="test-section">
      <h2>üõ°Ô∏è XSS Protection Tests</h2>
      <p>Instructions for manual XSS testing</p>
      <button onclick="testXSS()">View XSS Test Instructions</button>
    </div>

    <div class="test-section">
      <h2>üöÄ Run All Tests</h2>
      <button onclick="runAllTests()" style="background: #10b981">
        Run Complete Security Audit
      </button>
      <button onclick="clearResults()" style="background: #6b7280">
        Clear Results
      </button>
    </div>

    <pre id="results">Click a button to run security tests...</pre>

    <!-- Hidden XSS Test Instructions -->
    <div
      id="xss-instructions"
      class="test-section"
      style="display: none; margin-top: 20px; border: 2px solid #fbbf24"
    >
      <h3 style="color: #333; margin-top: 0">
        üìã XSS Test Instructions (Manual Testing)
      </h3>

      <div
        style="
          background: #fff3cd;
          padding: 15px;
          border-radius: 4px;
          margin-bottom: 15px;
        "
      >
        <strong>‚ö†Ô∏è IMPORTANT:</strong> Delete all test events after testing!
      </div>

      <h4 style="color: #0ea5e9">Test 1: Admin Events Table</h4>
      <ol>
        <li>Go to <code>admin/events.html</code></li>
        <li>Login to admin portal</li>
        <li>
          Create a new event with this title:
          <code>&lt;script&gt;alert("XSS")&lt;/script&gt;</code>
        </li>
        <li>Save and view the events table</li>
        <li>
          Check browser:
          <ul>
            <li>
              <strong style="color: #f87171">‚ùå VULNERABLE:</strong> Alert fires
            </li>
            <li>
              <strong style="color: #4ade80">‚úÖ SECURE:</strong> Shows as plain
              text
            </li>
          </ul>
        </li>
      </ol>

      <h4 style="color: #0ea5e9">Test 2: Dashboard Recent Activity</h4>
      <ol>
        <li>Go to <code>admin/dashboard.html</code></li>
        <li>Check "Recent Activity" section</li>
        <li>Verify test event doesn't trigger JavaScript</li>
      </ol>

      <h4 style="color: #0ea5e9">Test 3: Public Calendar</h4>
      <ol>
        <li>Go to <code>pages/calendar.html</code></li>
        <li>Find your test event</li>
        <li>Verify XSS payload is escaped (shows as text)</li>
      </ol>

      <h4 style="color: #0ea5e9">Test 4: Image Tag XSS</h4>
      <ol>
        <li>
          Create another event with title:
          <code>&lt;img src=x onerror=alert("XSS2")&gt;</code>
        </li>
        <li>Verify it doesn't trigger alert</li>
      </ol>

      <h4 style="color: #0ea5e9">Test 5: Form Inputs</h4>
      <ol>
        <li>
          Try submitting contact form with HTML/JavaScript in message field
        </li>
        <li>Check if it's sanitized before storage/display</li>
      </ol>

      <div
        style="
          background: #fee2e2;
          padding: 15px;
          border-radius: 4px;
          margin-top: 15px;
        "
      >
        <strong>üóëÔ∏è CLEANUP:</strong> After testing, delete all test events from
        the admin portal!
      </div>
    </div>

    <script>
      const supabase = window.supabase.createClient(
        "https://pkomfbezaollhvcpezaw.supabase.co",
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBrb21mYmV6YW9sbGh2Y3BlemF3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4NjcxMTIsImV4cCI6MjA3NTQ0MzExMn0.E2__i0ieMKMYwx-bzk3rnZ9-ozQLSJxMIm3GhRKt8K0"
      );

      const log = (msg, type = "info") => {
        const results = document.getElementById("results");
        const className =
          type === "secure"
            ? "secure"
            : type === "vulnerable"
            ? "vulnerable"
            : type === "warning"
            ? "warning"
            : "info";
        const span = document.createElement("span");
        span.className = className;
        span.textContent = msg;
        results.appendChild(span);
        results.appendChild(document.createElement("br"));
        results.scrollTop = results.scrollHeight;
      };

      function clearResults() {
        document.getElementById("results").innerHTML = "";
      }

      async function testStorage() {
        log("\n========================================", "info");
        log("STORAGE SECURITY TESTS", "info");
        log("========================================\n", "info");

        // Test 1: Unauthenticated upload attempt
        log("Test 1: Unauthenticated PHP File Upload", "warning");
        try {
          const phpFile = new File(['<?php echo "hacked"; ?>'], "hack.php", {
            type: "application/x-php",
          });
          const { data, error } = await supabase.storage
            .from("media")
            .upload("hack.php", phpFile);

          if (error) {
            log(`  Result: ‚úÖ BLOCKED - ${error.message}`, "secure");
            log(`  Details: ${error.statusCode || "Policy violation"}`, "info");
          } else {
            log(`  Result: ‚ùå VULNERABLE - Upload succeeded!`, "vulnerable");
            log(`  Details: File uploaded to ${data.path}`, "vulnerable");
          }
        } catch (e) {
          log(`  Result: ‚úÖ BLOCKED - ${e.message}`, "secure");
        }

        // Test 2: Unauthenticated .exe upload
        log("\nTest 2: Unauthenticated EXE File Upload", "warning");
        try {
          const exeFile = new File(["MZ"], "virus.exe", {
            type: "application/x-msdownload",
          });
          const { data, error } = await supabase.storage
            .from("media")
            .upload("virus.exe", exeFile);

          if (error) {
            log(`  Result: ‚úÖ BLOCKED - ${error.message}`, "secure");
          } else {
            log(`  Result: ‚ùå VULNERABLE - Upload succeeded!`, "vulnerable");
          }
        } catch (e) {
          log(`  Result: ‚úÖ BLOCKED - ${e.message}`, "secure");
        }

        // Test 3: Large file upload (20MB)
        log("\nTest 3: Oversized File Upload (20MB)", "warning");
        try {
          const bigFile = new File(
            [new ArrayBuffer(20 * 1024 * 1024)],
            "big.jpg",
            { type: "image/jpeg" }
          );
          const { data, error } = await supabase.storage
            .from("media")
            .upload("big-test-" + Date.now() + ".jpg", bigFile);

          if (error) {
            log(`  Result: ‚úÖ BLOCKED - ${error.message}`, "secure");
          } else {
            log(`  Result: ‚ùå VULNERABLE - Large file uploaded!`, "vulnerable");
          }
        } catch (e) {
          log(`  Result: ‚úÖ BLOCKED - ${e.message}`, "secure");
        }

        // Test 4: Path traversal attempt
        log("\nTest 4: Path Traversal Attack", "warning");
        try {
          const normalFile = new File(["test"], "../../etc/passwd.jpg", {
            type: "image/jpeg",
          });
          const { data, error } = await supabase.storage
            .from("media")
            .upload("../../etc/passwd.jpg", normalFile);

          if (error) {
            log(`  Result: ‚úÖ BLOCKED - ${error.message}`, "secure");
          } else {
            log(
              `  Result: ‚ùå VULNERABLE - Path traversal worked!`,
              "vulnerable"
            );
            log(`  Uploaded to: ${data.path}`, "vulnerable");
          }
        } catch (e) {
          log(`  Result: ‚úÖ BLOCKED - ${e.message}`, "secure");
        }

        // Test 5: HTML file with JavaScript
        log("\nTest 5: HTML File with JavaScript", "warning");
        try {
          const htmlFile = new File(
            ['<script>alert("XSS")<\/script>'],
            "hack.html",
            { type: "text/html" }
          );
          const { data, error } = await supabase.storage
            .from("media")
            .upload("hack.html", htmlFile);

          if (error) {
            log(`  Result: ‚úÖ BLOCKED - ${error.message}`, "secure");
          } else {
            log(`  Result: ‚ùå VULNERABLE - HTML file uploaded!`, "vulnerable");
          }
        } catch (e) {
          log(`  Result: ‚úÖ BLOCKED - ${e.message}`, "secure");
        }

        log("\n‚úì Storage tests complete", "info");
      }

      async function testRLS() {
        log("\n========================================", "info");
        log("RLS POLICY TESTS", "info");
        log("========================================\n", "info");

        // Test 1: Read admin_users without authentication
        log("Test 1: Read admin_users Table (Unauthenticated)", "warning");
        try {
          const { data, error } = await supabase
            .from("admin_users")
            .select("*");

          if (error) {
            log(`  Result: ‚úÖ BLOCKED - ${error.message}`, "secure");
          } else if (data && data.length === 0) {
            log(`  Result: ‚úÖ SECURE - Empty result (policy block)`, "secure");
          } else {
            log(
              `  Result: ‚ùå VULNERABLE - Retrieved ${data.length} records!`,
              "vulnerable"
            );
            log(`  Data: ${JSON.stringify(data.slice(0, 2))}`, "vulnerable");
          }
        } catch (e) {
          log(`  Result: ‚úÖ BLOCKED - ${e.message}`, "secure");
        }

        // Test 2: Read draft/unpublished events
        log("\nTest 2: Read Draft Events (Unauthenticated)", "warning");
        try {
          const { data, error } = await supabase
            .from("events")
            .select("*")
            .eq("status", "draft");

          if (error) {
            log(`  Result: ‚úÖ BLOCKED - ${error.message}`, "secure");
          } else if (data && data.length === 0) {
            log(`  Result: ‚úÖ SECURE - No draft events visible`, "secure");
          } else {
            log(
              `  Result: ‚ùå VULNERABLE - Retrieved ${data.length} draft events!`,
              "vulnerable"
            );
          }
        } catch (e) {
          log(`  Result: ‚úÖ BLOCKED - ${e.message}`, "secure");
        }

        // Test 3: Try to update an event
        log("\nTest 3: Update Event (Unauthenticated)", "warning");
        try {
          const { data, error } = await supabase
            .from("events")
            .update({ title: "HACKED BY SECURITY TEST" })
            .eq("id", "00000000-0000-0000-0000-000000000000"); // Non-existent ID

          if (error) {
            log(`  Result: ‚úÖ BLOCKED - ${error.message}`, "secure");
          } else {
            log(`  Result: ‚ùå VULNERABLE - Update succeeded!`, "vulnerable");
          }
        } catch (e) {
          log(`  Result: ‚úÖ BLOCKED - ${e.message}`, "secure");
        }

        // Test 4: Try to delete an event
        log("\nTest 4: Delete Event (Unauthenticated)", "warning");
        try {
          const { data, error } = await supabase
            .from("events")
            .delete()
            .eq("id", "00000000-0000-0000-0000-000000000000");

          if (error) {
            log(`  Result: ‚úÖ BLOCKED - ${error.message}`, "secure");
          } else {
            log(`  Result: ‚ùå VULNERABLE - Delete succeeded!`, "vulnerable");
          }
        } catch (e) {
          log(`  Result: ‚úÖ BLOCKED - ${e.message}`, "secure");
        }

        // Test 5: Try to read admin_logs
        log("\nTest 5: Read Admin Logs (Unauthenticated)", "warning");
        try {
          const { data, error } = await supabase
            .from("admin_logs")
            .select("*")
            .limit(1);

          if (error) {
            log(`  Result: ‚úÖ BLOCKED - ${error.message}`, "secure");
          } else if (data && data.length === 0) {
            log(`  Result: ‚úÖ SECURE - No logs visible`, "secure");
          } else {
            log(
              `  Result: ‚ùå VULNERABLE - Retrieved ${data.length} log entries!`,
              "vulnerable"
            );
          }
        } catch (e) {
          log(`  Result: ‚úÖ BLOCKED - ${e.message}`, "secure");
        }

        // Test 6: Try to read site_content
        log("\nTest 6: Read Site Content (Unauthenticated)", "warning");
        try {
          const { data, error } = await supabase
            .from("site_content")
            .select("*");

          if (error) {
            log(`  Result: ‚ö†Ô∏è  ERROR - ${error.message}`, "warning");
            log(`  Note: Site content SHOULD be publicly readable`, "info");
          } else if (data && data.length > 0) {
            log(
              `  Result: ‚úÖ EXPECTED - Site content is public (${data.length} records)`,
              "secure"
            );
            log(
              `  Note: This is correct - public pages need this data`,
              "info"
            );
          } else {
            log(`  Result: No data found`, "info");
          }
        } catch (e) {
          log(`  Result: ERROR - ${e.message}`, "warning");
        }

        log("\n‚úì RLS tests complete", "info");
      }

      function testXSS() {
        const instructions = document.getElementById("xss-instructions");
        const results = document.getElementById("results");

        results.innerHTML = "";
        log("\n========================================", "info");
        log("XSS PROTECTION TEST INSTRUCTIONS", "info");
        log("========================================\n", "info");
        log("See detailed instructions below the test buttons.", "info");

        // Show the instructions
        instructions.style.display = "block";
        instructions.scrollIntoView({ behavior: "smooth" });
      }

      async function runAllTests() {
        clearResults();
        log("üîí COMPREHENSIVE SECURITY AUDIT", "info");
        log("Starting all automated tests...\n", "info");

        await testStorage();
        await new Promise((resolve) => setTimeout(resolve, 1000));
        await testRLS();
        await new Promise((resolve) => setTimeout(resolve, 1000));

        log("\n========================================", "info");
        log("AUDIT COMPLETE", "info");
        log("========================================", "info");
        log(
          '\nFor XSS testing, click "View XSS Test Instructions" button.',
          "info"
        );
        log("Review results above and fix any ‚ùå VULNERABLE items.", "warning");
        log("Document findings in SECURITY-AUDIT-REPORT.md", "info");
      }
    </script>
  </body>
</html>
