<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dog Bar Admin - Media Library</title>

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="../assets/media/logo.png?v=2" />

    <!-- Compiled Tailwind CSS -->
    <link rel="stylesheet" href="../assets/css/tailwind.output.css" />

    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- Supabase -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <!-- Shared Scripts -->
    <script type="module" src="shared/permissions.js"></script>
    <script type="module" src="shared/navigation.js"></script>

    <style>
      body {
        font-family: "Inter", sans-serif;
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        min-height: 100vh;
      }

      .media-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 16px;
        background: linear-gradient(135deg, #475569 0%, #334155 100%);
        padding: 20px;
        border-radius: 12px;
        border: 1px solid #475569;
      }

      .media-item {
        position: relative;
        aspect-ratio: 1;
        border-radius: 8px;
        overflow: hidden;
        cursor: pointer;
        transition: all 0.2s;
        border: 2px solid transparent;
        background: transparent;
      }

      .media-item:hover {
        transform: scale(1.02);
        border-color: #10b981;
      }

      .media-item.selected {
        border-color: #10b981;
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.3);
        transform: scale(0.98);
      }

      /* Checkbox styles - show on hover or when checked */
      .media-checkbox {
        opacity: 0;
        transition: opacity 0.2s;
      }

      .media-item:hover .media-checkbox,
      .media-checkbox:checked {
        opacity: 1;
      }

      .media-item img {
        width: 100%;
        height: 100%;
        object-fit: contain;
        background: transparent;
      }

      .media-item video {
        width: 100%;
        height: 100%;
        object-fit: contain;
        background: transparent;
      }

      .media-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(
          to bottom,
          rgba(0, 0, 0, 0.7) 0%,
          transparent 50%,
          rgba(0, 0, 0, 0.7) 100%
        );
        opacity: 0;
        transition: opacity 0.2s;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        padding: 8px;
      }

      .media-item:hover .media-overlay {
        opacity: 1;
      }

      .media-actions {
        display: flex;
        gap: 4px;
        justify-content: flex-end;
      }

      .media-info {
        color: white;
        font-size: 12px;
        font-weight: 500;
      }

      .upload-area {
        border: 2px dashed #d1d5db;
        border-radius: 8px;
        padding: 40px;
        text-align: center;
        transition: all 0.2s;
        cursor: pointer;
      }

      .upload-area:hover {
        border-color: #10b981;
        background-color: #f0fdf4;
      }

      .upload-area.dragover {
        border-color: #059669;
        background-color: #dcfce7;
      }
    </style>
  </head>
  <body class="bg-gray-100 min-h-screen">
    <!-- Selection Mode Banner -->
    <div id="selection-mode-banner" class="hidden bg-emerald-600 text-white py-3 px-4">
      <div class="max-w-7xl mx-auto flex items-center justify-between">
        <div class="flex items-center">
          <span class="text-lg font-semibold mr-2">üìÅ Selection Mode:</span>
          <span id="selection-context">Select a file for hero background</span>
        </div>
        <button onclick="cancelMediaSelection()" class="px-4 py-1 bg-white text-emerald-600 rounded hover:bg-gray-100 font-medium">
          Cancel
        </button>
      </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
      <!-- Page Header -->
      <div class="flex justify-between items-center mb-8">
        <div>
          <h2 class="text-3xl font-bold text-gray-900">Media Library</h2>
          <p class="text-gray-600">
            Upload, organize, and manage your media files
          </p>
        </div>
        <div class="flex gap-4">
          <button
            id="cleanupBtn"
            class="bg-orange-600 text-white px-6 py-3 rounded-lg hover:bg-orange-700 transition-colors flex items-center"
            title="Clean up orphaned files and refresh media list"
          >
            <svg
              class="w-5 h-5 mr-2"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
              ></path>
            </svg>
            Refresh
          </button>
        </div>
      </div>

      <!-- Upload Area -->
      <div class="mb-8">
        <div id="uploadArea" class="upload-area">
          <svg
            class="mx-auto h-12 w-12 text-gray-400 mb-4"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"
            ></path>
          </svg>
          <p class="text-lg font-medium text-gray-900 mb-2">
            Upload Media Files
          </p>
          <p class="text-gray-600">
            Drag and drop files here, or click to browse
          </p>
          <p class="text-sm text-gray-500 mt-2">
            PNG, JPG, GIF, MP4 up to 10MB each
          </p>
        </div>
        <input
          type="file"
          id="fileInput"
          multiple
          accept="image/*,video/*"
          class="hidden"
        />
      </div>

      <!-- Filter and Search -->
      <div class="bg-white shadow rounded-lg mb-6">
        <div class="px-6 py-4 border-b border-gray-200 flex flex-col gap-4">
          <div>
            <h3 class="text-lg font-medium text-gray-900">Filter Media</h3>
            <p class="text-sm text-gray-600">Search and limit media results</p>
          </div>
          <div class="flex flex-col lg:flex-row lg:items-center gap-4">
            <div class="flex-1 min-w-[200px]">
              <input
                type="text"
                id="searchInput"
                placeholder="Search by file name..."
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
              />
            </div>
            <div class="flex flex-wrap items-center gap-2">
              <label class="text-sm text-gray-600">Type:</label>
              <select
                id="typeFilter"
                class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
              >
                <option value="all">All Types</option>
                <option value="image">Images</option>
                <option value="video">Videos</option>
              </select>
              <label class="text-sm text-gray-600">Sort:</label>
              <select
                id="sortBy"
                class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
              >
                <option value="newest">Newest First</option>
                <option value="oldest">Oldest First</option>
                <option value="name">Name A-Z</option>
                <option value="size">Size</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <!-- Selection Toolbar (shows when items selected) -->
      <div
        id="selectionToolbar"
        class="hidden bg-blue-50 border-l-4 border-blue-400 p-4 mb-4 rounded-lg"
      >
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-4">
            <svg
              class="w-5 h-5 text-blue-600"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
              ></path>
            </svg>
            <span class="text-blue-800 font-medium">
              <span id="selectedCount">0</span> items selected
            </span>
          </div>
          <div class="flex gap-2">
            <button
              id="clearSelectionBtn"
              class="px-4 py-2 border-2 border-gray-300 text-gray-700 bg-white rounded-lg hover:bg-gray-50 hover:border-gray-400 transition font-medium"
            >
              Clear Selection
            </button>
            <button
              id="deleteSelectedToolbarBtn"
              class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition flex items-center gap-2 font-medium"
            >
              <svg
                class="w-4 h-4"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                ></path>
              </svg>
              Delete Selected
            </button>
          </div>
        </div>
      </div>

      <!-- Media Grid -->
      <div class="bg-white rounded-xl shadow-lg p-6">
        <div class="flex justify-between items-center mb-4">
          <div class="flex items-center gap-4">
            <!-- Select All Checkbox -->
            <label class="flex items-center gap-2 cursor-pointer">
              <input
                type="checkbox"
                id="selectAllCheckbox"
                class="w-5 h-5 text-emerald-600 rounded border-gray-300 focus:ring-emerald-500 focus:ring-2 cursor-pointer"
              />
              <span class="text-sm font-medium text-gray-700">Select All</span>
            </label>
            <h3 class="text-lg font-semibold text-gray-900">Media Files</h3>
          </div>
          <div class="flex items-center gap-4">
            <span id="fileCount" class="text-sm text-gray-600">0 files</span>
            <div class="flex gap-2">
              <button
                id="gridViewBtn"
                class="p-2 rounded-lg bg-emerald-100 text-emerald-600"
                title="Grid View"
              >
                <svg
                  class="w-5 h-5"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"
                  ></path>
                </svg>
              </button>
              <button
                id="listViewBtn"
                class="p-2 rounded-lg text-gray-400 hover:bg-gray-100"
                title="List View"
              >
                <svg
                  class="w-5 h-5"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M4 6h16M4 10h16M4 14h16M4 18h16"
                  ></path>
                </svg>
              </button>
            </div>
          </div>
        </div>

        <!-- Pagination Controls (Top) -->
        <div class="bg-white border-y border-gray-200 py-4 mb-4">
          <div
            id="paginationControls"
            class="flex flex-col md:flex-row md:items-center md:justify-between gap-3"
          ></div>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="text-center py-8">
          <div
            class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-emerald-600"
          ></div>
          <p class="text-gray-600 mt-2">Loading media files...</p>
        </div>

        <!-- Media Grid -->
        <div id="mediaGrid" class="media-grid hidden">
          <!-- Media items will be loaded here -->
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="text-center py-12 hidden">
          <svg
            class="mx-auto h-12 w-12 text-gray-400 mb-4"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
            ></path>
          </svg>
          <h3 class="text-lg font-medium text-gray-900 mb-2">
            No media files found
          </h3>
          <p class="text-gray-600 mb-4">
            Upload some media files to get started
          </p>
          <button
            id="uploadEmptyBtn"
            class="bg-emerald-600 text-white px-6 py-3 rounded-lg hover:bg-emerald-700 transition-colors"
          >
            Upload Media
          </button>
        </div>
      </div>
    </div>

    <!-- Media Viewer Overlay -->
    <div
      id="mediaViewer"
      class="fixed inset-0 z-40 hidden opacity-0 transition-opacity duration-200"
      aria-hidden="true"
    >
      <div
        id="mediaViewerBackdrop"
        class="absolute inset-0 bg-gray-900/80 backdrop-blur-sm"
      ></div>
      <div class="absolute inset-0 flex items-center justify-center px-6 py-10">
        <div
          id="viewerContent"
          class="relative bg-gray-900/95 border border-gray-700 shadow-2xl max-w-6xl w-full max-h-[90vh] flex flex-col overflow-hidden"
        >
          <button
            id="viewerCloseBtn"
            class="absolute right-6 top-6 text-gray-400 hover:text-white transition"
            aria-label="Close viewer"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              ></path>
            </svg>
          </button>

          <div class="px-8 pt-8 pb-4 text-white">
            <div
              class="flex flex-col md:flex-row md:items-center md:justify-between gap-4"
            >
              <div>
                <h3 id="viewerTitle" class="text-2xl font-semibold truncate">
                  File name
                </h3>
                <p id="viewerMeta" class="text-sm text-gray-300 mt-1">
                  File details
                </p>
              </div>
              <div class="flex items-center gap-3">
                <button
                  id="viewerDeleteBtn"
                  class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-red-600/80 hover:bg-red-600 transition text-white"
                >
                  <svg
                    class="w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                    ></path>
                  </svg>
                  Delete
                </button>
                <button
                  id="viewerEditBtn"
                  class="inline-flex items-center gap-2 px-4 py-2 rounded-full border border-emerald-400/60 text-emerald-200/80 hover:text-white hover:border-emerald-300/80 transition"
                >
                  <svg
                    class="w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L12 21l-4 1 1-4L20.586 5.586z"
                    ></path>
                  </svg>
                  Edit (coming soon)
                </button>
              </div>
            </div>
          </div>

          <div
            class="relative flex-1 flex items-center justify-center px-6 pb-10"
          >
            <button
              id="viewerPrevBtn"
              class="absolute left-4 md:left-8 p-3 md:p-4 rounded-full bg-black/50 text-white hover:bg-emerald-600/80 transition disabled:opacity-40 disabled:pointer-events-none"
              aria-label="Previous image"
            >
              <svg
                class="w-6 h-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15 19l-7-7 7-7"
                ></path>
              </svg>
            </button>

            <img
              id="viewerImage"
              src=""
              alt="Expanded media"
              class="max-h-[65vh] md:max-h-[70vh] object-contain border border-gray-700/60 bg-gray-800/60 shadow-xl"
            />

            <video
              id="viewerVideo"
              controls
              class="hidden max-h-[65vh] md:max-h-[70vh] object-contain border border-gray-700/60 bg-gray-800/60 shadow-xl"
            >
              <source src="" type="video/mp4" />
              Your browser does not support video playback.
            </video>

            <button
              id="viewerNextBtn"
              class="absolute right-4 md:right-8 p-3 md:p-4 rounded-full bg-black/50 text-white hover:bg-emerald-600/80 transition disabled:opacity-40 disabled:pointer-events-none"
              aria-label="Next image"
            >
              <svg
                class="w-6 h-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 5l7 7-7 7"
                ></path>
              </svg>
            </button>
          </div>

          <div class="px-8 pb-6 text-gray-400 text-sm">
            <p>
              Use the arrow keys or on-screen controls to navigate. Press Esc to
              close.
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div
      id="deleteModal"
      class="fixed inset-0 z-50 hidden opacity-0 transition-opacity duration-200"
      aria-hidden="true"
    >
      <div class="absolute inset-0 bg-gray-900/70 backdrop-blur-sm"></div>
      <div class="absolute inset-0 flex items-center justify-center px-4">
        <div
          class="relative bg-white rounded-2xl shadow-2xl max-w-lg w-full overflow-hidden"
        >
          <div class="flex items-start gap-4 px-6 pt-6">
            <div
              class="flex h-12 w-12 items-center justify-center rounded-full bg-red-100 text-red-600"
            >
              <svg
                class="w-6 h-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                ></path>
              </svg>
            </div>
            <div class="flex-1">
              <div class="flex items-start justify-between gap-4">
                <div>
                  <h3
                    id="deleteModalTitle"
                    class="text-xl font-semibold text-gray-900"
                  >
                    Delete file?
                  </h3>
                  <p id="deleteModalDetail" class="text-sm text-gray-600 mt-1">
                    This action will permanently remove the file from storage.
                  </p>
                </div>
                <button
                  id="deleteModalCloseBtn"
                  class="text-gray-400 hover:text-gray-600 transition"
                  aria-label="Close delete dialog"
                >
                  <svg
                    class="w-5 h-5"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M6 18L18 6M6 6l12 12"
                    ></path>
                  </svg>
                </button>
              </div>
              <div id="deleteModalList" class="mt-4 space-y-3"></div>
              <p
                id="deleteModalExtraCount"
                class="mt-2 text-sm text-gray-500 hidden"
              ></p>
            </div>
          </div>
          <div class="px-6 py-5 bg-gray-50 flex justify-end gap-3">
            <button
              id="deleteModalCancelBtn"
              class="px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-100 transition"
            >
              Cancel
            </button>
            <button
              id="deleteModalConfirmBtn"
              class="px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700 transition flex items-center gap-2"
            >
              <svg
                class="w-4 h-4"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                ></path>
              </svg>
              Delete
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- File Naming Modal -->
    <div
      id="namingModal"
      class="fixed inset-0 z-50 hidden opacity-0 transition-opacity duration-200"
      aria-hidden="true"
    >
      <div class="absolute inset-0 bg-gray-900/70 backdrop-blur-sm"></div>
      <div class="absolute inset-0 flex items-center justify-center px-4">
        <div
          class="relative bg-white rounded-2xl shadow-2xl max-w-lg w-full overflow-hidden"
        >
          <div class="flex items-start gap-4 px-6 pt-6">
            <div
              class="flex h-12 w-12 items-center justify-center rounded-full bg-blue-100 text-blue-600"
            >
              <svg
                class="w-6 h-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"
                ></path>
              </svg>
            </div>
            <div class="flex-1">
              <h3 class="text-lg font-semibold text-gray-900 mb-2">
                Name Your File
              </h3>
              <p class="text-gray-600 mb-4">
                Choose a descriptive name for your file
              </p>

              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">
                    Original file:
                    <span id="originalFileName" class="text-gray-500"></span>
                  </label>
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">
                    Choose a name:
                  </label>
                  <select
                    id="nameDropdown"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  >
                    <option value="">Select category...</option>
                    <option value="menu">Menu</option>
                    <option value="dog-park-photo">Dog Park Photo</option>
                    <option value="event-photo">Event Photo</option>
                    <option value="food-truck-logo">Food Truck Logo</option>
                    <option value="promotional-image">Promotional Image</option>
                    <option value="hero-banner">Hero Banner</option>
                    <option value="custom">Custom...</option>
                  </select>
                </div>

                <div id="customNameContainer" class="hidden">
                  <label class="block text-sm font-medium text-gray-700 mb-2">
                    Enter custom name:
                  </label>
                  <input
                    type="text"
                    id="customNameInput"
                    placeholder="Enter file name..."
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  />
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">
                    Final filename:
                    <span
                      id="finalFileName"
                      class="text-blue-600 font-medium"
                    ></span>
                  </label>
                </div>

                <div id="uploadProgressContainer" class="hidden mt-4">
                  <p
                    id="uploadProgressText"
                    class="text-sm text-gray-600 mb-2"
                  ></p>
                  <div
                    class="w-full bg-gray-200 rounded-full h-2.5 overflow-hidden"
                  >
                    <div
                      id="uploadProgressBar"
                      class="bg-blue-600 h-2.5 rounded-full transition-all duration-200"
                      style="width: 0%"
                    ></div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="flex items-center justify-end gap-3 px-6 py-4 bg-gray-50">
            <button
              id="cancelNaming"
              class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 focus:ring-2 focus:ring-gray-500 focus:ring-offset-2"
            >
              Cancel
            </button>
            <button
              id="confirmNaming"
              class="px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-lg hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
            >
              Upload File
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Upload Error Modal -->
    <div
      id="uploadErrorModal"
      class="fixed inset-0 z-50 hidden opacity-0 transition-opacity duration-200"
      aria-hidden="true"
    >
      <div class="absolute inset-0 bg-gray-900/70 backdrop-blur-sm"></div>
      <div class="absolute inset-0 flex items-center justify-center px-4">
        <div
          class="relative bg-white rounded-2xl shadow-2xl max-w-lg w-full overflow-hidden"
        >
          <div class="flex items-start gap-4 px-6 pt-6">
            <div
              class="flex h-12 w-12 items-center justify-center rounded-full bg-red-100 text-red-600"
            >
              <svg
                class="w-6 h-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                />
              </svg>
            </div>
            <div class="flex-1">
              <h3 class="text-lg font-semibold text-gray-900 mb-1">
                Upload Issues Detected
              </h3>
              <p class="text-gray-600 mb-4">
                Some files could not be uploaded after a retry. Review the list
                below and try again.
              </p>
              <div
                id="uploadErrorList"
                class="max-h-60 overflow-y-auto border border-gray-200 rounded-lg divide-y divide-gray-200"
              ></div>
            </div>
          </div>
          <div class="px-6 py-4 bg-gray-50 flex justify-end">
            <button
              id="uploadErrorCloseBtn"
              class="px-4 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700 transition"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Deletion Progress Modal -->
    <div
      id="deletionProgressModal"
      class="fixed inset-0 z-50 hidden opacity-0 transition-opacity duration-200"
      aria-hidden="true"
    >
      <div class="absolute inset-0 bg-gray-900/70 backdrop-blur-sm"></div>
      <div class="absolute inset-0 flex items-center justify-center px-4">
        <div
          class="relative bg-white rounded-2xl shadow-2xl max-w-md w-full overflow-hidden"
        >
          <div class="px-6 pt-6 pb-4">
            <div class="flex items-center gap-4 mb-4">
              <div
                class="flex h-12 w-12 items-center justify-center rounded-full bg-red-100 text-red-600"
              >
                <svg
                  class="w-6 h-6"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                  ></path>
                </svg>
              </div>
              <div class="flex-1">
                <h3 class="text-lg font-semibold text-gray-900">
                  Deleting Files...
                </h3>
                <p id="deletionProgressText" class="text-sm text-gray-600 mt-1">
                  Preparing to delete files...
                </p>
              </div>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2.5 overflow-hidden">
              <div
                id="deletionProgressBar"
                class="bg-red-600 h-2.5 rounded-full transition-all duration-300"
                style="width: 0%"
              ></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Supabase configuration
      const supabaseUrl = "https://pkomfbezaollhvcpezaw.supabase.co";
      const supabaseKey =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBrb21mYmV6YW9sbGh2Y3BlemF3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4NjcxMTIsImV4cCI6MjA3NTQ0MzExMn0.E2__i0ieMKMYwx-bzk3rnZ9-ozQLSJxMIm3GhRKt8K0";
      const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

      let mediaFiles = [];
      let selectedFiles = new Set();
      let filteredFiles = [];
      let failedUploads = [];
      let allFilteredFiles = []; // Store all filtered results for viewer navigation
      let totalFilteredFiles = 0;

      // Image cache for better performance
      const imageCache = new Map();

      // Cache image in memory for faster subsequent loads
      function getCachedImage(url) {
        if (imageCache.has(url)) {
          return imageCache.get(url);
        }

        const promise = new Promise((resolve, reject) => {
          const img = new Image();
          img.onload = () => resolve(url);
          img.onerror = reject;
          img.src = url;
        });

        imageCache.set(url, promise);
        return promise;
      }

      // Preload visible images for better performance
      function preloadVisibleImages() {
        filteredFiles.forEach((file) => {
          getCachedImage(file.thumbUrl || file.url).catch((err) =>
            console.warn("Failed to preload image:", file.name, err)
          );
        });
      }

      let listenersInitialized = false;
      let progressElements = {
        container: null,
        text: null,
        bar: null,
      };

      const viewerElements = {
        container: document.getElementById("mediaViewer"),
        backdrop: document.getElementById("mediaViewerBackdrop"),
        content: document.getElementById("viewerContent"),
        image: document.getElementById("viewerImage"),
        video: document.getElementById("viewerVideo"),
        title: document.getElementById("viewerTitle"),
        meta: document.getElementById("viewerMeta"),
        closeBtn: document.getElementById("viewerCloseBtn"),
        prevBtn: document.getElementById("viewerPrevBtn"),
        nextBtn: document.getElementById("viewerNextBtn"),
        deleteBtn: document.getElementById("viewerDeleteBtn"),
        editBtn: document.getElementById("viewerEditBtn"),
      };

      const deleteModalElements = {
        container: document.getElementById("deleteModal"),
        list: document.getElementById("deleteModalList"),
        extraCount: document.getElementById("deleteModalExtraCount"),
        title: document.getElementById("deleteModalTitle"),
        detail: document.getElementById("deleteModalDetail"),
        closeBtn: document.getElementById("deleteModalCloseBtn"),
        cancelBtn: document.getElementById("deleteModalCancelBtn"),
        confirmBtn: document.getElementById("deleteModalConfirmBtn"),
      };

      let viewerIndex = -1;
      let overlayDepth = 0;
      let pendingDelete = null;

      const overlayHandlers = new Set();

      // Initialize media library
      document.addEventListener("DOMContentLoaded", async function () {
        // Attach listeners early so click/drag works even if auth checks run later
        ensureEventListeners();
        await checkAuth();
      });

      // Check authentication
      async function checkAuth() {
        const token = localStorage.getItem("supabase.auth.token");
        if (!token) {
          window.location.href = "login.html";
          return;
        }

        try {
          const {
            data: { user },
            error,
          } = await supabase.auth.getUser();
          if (error || !user) {
            window.location.href = "login.html";
            return;
          }

          const userEmailEl = document.getElementById("userEmail");
          if (userEmailEl) userEmailEl.textContent = user.email;
          if (
            window.adminNavigation &&
            typeof window.adminNavigation.setUserEmail === "function"
          ) {
            window.adminNavigation.setUserEmail(user.email);
          }

          // Wait for PermissionManager to be initialized
          let attempts = 0;
          const maxAttempts = 20; // Increased timeout

          while (
            !window.PermissionManager ||
            !window.PermissionManager.userRole
          ) {
            if (attempts >= maxAttempts) {
              console.warn(
                "‚ö†Ô∏è PermissionManager not ready, continuing anyway..."
              );
              // Don't return; proceed with defaults
              break;
            }
            await new Promise((resolve) => setTimeout(resolve, 100));
            attempts++;
          }

          // Default to allowing media management if PermissionManager isn't ready
          let hasMediaPermission = window.PermissionManager
            ? window.PermissionManager.hasPermission("manage_media")
            : true;

          if (!hasMediaPermission) {
            alert("You do not have permission to manage media.");
            window.location.href = "dashboard.html";
            return;
          }

          // Initialize listeners first, then load media
          ensureEventListeners();
          await loadMediaFiles();
        } catch (error) {
          console.error("Auth check failed:", error);
          window.location.href = "login.html";
        }
      }

      function ensureEventListeners() {
        if (listenersInitialized) return;
        setupEventListeners();
        listenersInitialized = true;
      }

      // Setup event listeners
      function setupEventListeners() {
        // Upload area
        const uploadArea = document.getElementById("uploadArea");
        const fileInput = document.getElementById("fileInput");

        console.log("üì¶ Media: setupEventListeners", { uploadArea, fileInput });

        if (!uploadArea || !fileInput) {
          console.error("‚ùå Media: upload area or file input missing", {
            uploadArea,
            fileInput,
          });
        } else {
          uploadArea.addEventListener("click", () => {
            console.log("üì¶ Media: upload area clicked");
            fileInput.click();
          });
          uploadArea.addEventListener("dragover", handleDragOver);
          uploadArea.addEventListener("dragleave", handleDragLeave);
          uploadArea.addEventListener("drop", handleDrop);
        }

        // Prevent browser from opening files when dropped on the page
        const preventDefaultDrop = (event) => {
          event.preventDefault();
        };

        document.addEventListener("dragover", preventDefaultDrop, {
          passive: false,
        });
        document.addEventListener("drop", preventDefaultDrop, {
          passive: false,
        });

        // File input
        if (fileInput) {
          fileInput.addEventListener("change", handleFileSelect);
        }

        // Search and filters
        const searchInput = document.getElementById("searchInput");
        const typeFilter = document.getElementById("typeFilter");
        const sortBy = document.getElementById("sortBy");
        if (searchInput)
          searchInput.addEventListener("input", () => {
            currentPage = 1;
            filterFiles();
          });
        if (typeFilter)
          typeFilter.addEventListener("change", () => {
            currentPage = 1;
            filterFiles();
          });
        if (sortBy)
          sortBy.addEventListener("change", () => {
            currentPage = 1;
            filterFiles();
          });

        // Upload buttons
        const uploadEmptyBtn = document.getElementById("uploadEmptyBtn");
        if (uploadEmptyBtn)
          uploadEmptyBtn.addEventListener(
            "click",
            () => fileInput && fileInput.click()
          );

        // Cleanup button
        const cleanupBtn = document.getElementById("cleanupBtn");
        if (cleanupBtn) {
          cleanupBtn.addEventListener("click", async () => {
            cleanupBtn.disabled = true;
            cleanupBtn.innerHTML = `
              <svg class="w-5 h-5 mr-2 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
              </svg>
              Refreshing...
            `;

            try {
              await cleanupOrphanedFiles();
            } finally {
              cleanupBtn.disabled = false;
              cleanupBtn.innerHTML = `
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                Refresh
              `;
            }
          });
        }

        // Delete selected
        const deleteSelectedBtn = document.getElementById("deleteSelectedBtn");
        if (deleteSelectedBtn)
          deleteSelectedBtn.addEventListener("click", deleteSelectedFiles);

        // Selection controls
        const selectAllCheckbox = document.getElementById("selectAllCheckbox");
        if (selectAllCheckbox) {
          selectAllCheckbox.addEventListener("change", (e) => {
            if (e.target.checked) {
              // Select all visible files on current page
              filteredFiles.forEach((file) => selectedFiles.add(file.id));
            } else {
              // Deselect all
              selectedFiles.clear();
            }
            updateSelectionUI();
            renderMediaGrid();
          });
        }

        // Clear selection button
        const clearSelectionBtn = document.getElementById("clearSelectionBtn");
        if (clearSelectionBtn) {
          clearSelectionBtn.addEventListener("click", () => {
            selectedFiles.clear();
            updateSelectionUI();
            renderMediaGrid();
          });
        }

        // Delete selected from toolbar
        const deleteSelectedToolbarBtn = document.getElementById(
          "deleteSelectedToolbarBtn"
        );
        if (deleteSelectedToolbarBtn) {
          deleteSelectedToolbarBtn.addEventListener(
            "click",
            deleteSelectedFiles
          );
        }

        // Media viewer controls
        if (viewerElements.closeBtn)
          viewerElements.closeBtn.addEventListener("click", closeViewer);
        if (viewerElements.backdrop)
          viewerElements.backdrop.addEventListener("click", closeViewer);
        if (viewerElements.prevBtn)
          viewerElements.prevBtn.addEventListener("click", () =>
            navigateViewer(-1)
          );
        if (viewerElements.nextBtn)
          viewerElements.nextBtn.addEventListener("click", () =>
            navigateViewer(1)
          );
        if (viewerElements.deleteBtn)
          viewerElements.deleteBtn.addEventListener("click", () => {
            if (viewerIndex >= 0) {
              const file = allFilteredFiles[viewerIndex];
              if (file) openDeleteModal([file.id]);
            }
          });
        if (viewerElements.editBtn)
          viewerElements.editBtn.addEventListener("click", () => {
            alert("Edit tools (crop/text overlays) coming soon.");
          });

        document.addEventListener("keydown", handleGlobalKeydown);

        // Delete modal controls
        if (deleteModalElements.closeBtn)
          deleteModalElements.closeBtn.addEventListener(
            "click",
            closeDeleteModal
          );
        if (deleteModalElements.cancelBtn)
          deleteModalElements.cancelBtn.addEventListener(
            "click",
            closeDeleteModal
          );
        if (deleteModalElements.container)
          deleteModalElements.container.addEventListener("click", (event) => {
            if (event.target === deleteModalElements.container)
              closeDeleteModal();
          });
        if (deleteModalElements.confirmBtn)
          deleteModalElements.confirmBtn.addEventListener(
            "click",
            confirmDelete
          );

        // Naming modal controls
        const namingModal = document.getElementById("namingModal");
        const nameDropdown = document.getElementById("nameDropdown");
        const customNameInput = document.getElementById("customNameInput");
        const customNameContainer = document.getElementById(
          "customNameContainer"
        );
        const cancelNaming = document.getElementById("cancelNaming");
        const confirmNaming = document.getElementById("confirmNaming");
        const progressContainer = document.getElementById(
          "uploadProgressContainer"
        );
        const progressText = document.getElementById("uploadProgressText");
        const progressBar = document.getElementById("uploadProgressBar");
        const errorCloseBtn = document.getElementById("uploadErrorCloseBtn");

        progressElements = {
          container: progressContainer,
          text: progressText,
          bar: progressBar,
        };

        if (errorCloseBtn) {
          errorCloseBtn.addEventListener("click", closeUploadErrorModal);
        }

        if (nameDropdown) {
          nameDropdown.addEventListener("change", (e) => {
            if (e.target.value === "custom") {
              customNameContainer.classList.remove("hidden");
              customNameInput.focus();
            } else {
              customNameContainer.classList.add("hidden");
            }
            if (pendingFiles.length > 0) {
              updateFinalFileName(pendingFiles[currentFileIndex]);
            }
          });
        }

        if (customNameInput) {
          customNameInput.addEventListener("input", () => {
            if (pendingFiles.length > 0) {
              updateFinalFileName(pendingFiles[currentFileIndex]);
            }
          });
        }

        if (cancelNaming) {
          cancelNaming.addEventListener("click", closeNamingModal);
        }

        if (confirmNaming) {
          confirmNaming.addEventListener("click", async () => {
            if (pendingFiles.length === 0) return;

            const dropdown = document.getElementById("nameDropdown");
            const customInput = document.getElementById("customNameInput");

            const selectedOption = dropdown.value;
            let nameChoice = "";

            if (selectedOption === "custom") {
              nameChoice = customInput.value.trim();
            } else if (selectedOption) {
              nameChoice = selectedOption;
            }

            batchSelectedName = nameChoice;

            try {
              if (confirmNaming) {
                confirmNaming.disabled = true;
                confirmNaming.textContent = "Uploading...";
              }
              if (cancelNaming) cancelNaming.disabled = true;
              if (progressContainer) {
                progressContainer.classList.remove("hidden");
              }

              currentFileIndex = 0;
              await processBatchUpload(batchSelectedName);

              closeNamingModal();
              await loadMediaFiles();
            } catch (error) {
              console.error("Batch upload failed:", error);
              alert("Upload failed. Please try again.");
            } finally {
              if (confirmNaming) {
                confirmNaming.disabled = false;
                confirmNaming.textContent = "Upload File";
              }
              if (cancelNaming) cancelNaming.disabled = false;
              resetUploadProgress();
            }
          });
        }

        if (namingModal) {
          namingModal.addEventListener("click", (event) => {
            if (event.target === namingModal) {
              closeNamingModal();
            }
          });
        }
      }

      // Load media files from Supabase Storage
      async function loadMediaFiles() {
        try {
          console.log("üîÑ Loading media files from storage...");

          const { data, error } = await supabase.storage
            .from("media")
            .list("", {
              limit: 500,
              offset: 0,
            });

          if (error) throw error;

          console.log(`üìÅ Found ${data.length} files in storage bucket`);

          // Convert to media file objects and filter out invalid entries
          mediaFiles = data
            .filter((file) => {
              // Filter out files with no name or invalid metadata
              if (!file.name || file.name.trim() === "") {
                console.warn("‚ö†Ô∏è Skipping file with no name:", file);
                return false;
              }
              return true;
            })
            .map((file) => {
              const { data: publicData } = supabase.storage
                .from("media")
                .getPublicUrl(file.name);

              let thumbUrl = publicData?.publicUrl || "";

              if (file.metadata?.mimetype?.startsWith("image/")) {
                const { data: thumbData } = supabase.storage
                  .from("media")
                  .getPublicUrl(file.name, {
                    transform: {
                      width: 600,
                      height: 600,
                      resize: "cover",
                      quality: 70,
                    },
                  });

                if (thumbData?.publicUrl) {
                  thumbUrl = thumbData.publicUrl;
                }
              }

              const fileObj = {
                id: file.id,
                name: file.name,
                size: file.metadata?.size || 0,
                type: file.metadata?.mimetype || "image/jpeg",
                url: publicData?.publicUrl || "",
                thumbUrl: thumbUrl,
                created_at: file.created_at,
                isImage: file.metadata?.mimetype?.startsWith("image/") || false,
                isVideo: file.metadata?.mimetype?.startsWith("video/") || false,
              };

              // Debug logging for thumbnail issues
              console.log(`üìÅ File: ${file.name}`, {
                mimetype: file.metadata?.mimetype,
                isImage: fileObj.isImage,
                isVideo: fileObj.isVideo,
                url: fileObj.url,
                size: fileObj.size,
              });

              return fileObj;
            });

          filterFiles();
        } catch (error) {
          console.error("Error loading media files:", error);
          showEmptyState();
        }
      }

      // Filter and sort files
      function filterFiles() {
        const searchTerm = document
          .getElementById("searchInput")
          .value.toLowerCase();
        const typeFilter = document.getElementById("typeFilter").value;
        const sortBy = document.getElementById("sortBy").value;

        // Filter all files (store in allFilteredFiles for viewer navigation)
        allFilteredFiles = mediaFiles.filter((file) => {
          const matchesSearch = file.name.toLowerCase().includes(searchTerm);
          const matchesType =
            typeFilter === "all" ||
            (typeFilter === "image" && file.isImage) ||
            (typeFilter === "video" && file.isVideo);
          return matchesSearch && matchesType;
        });

        // Sort all filtered files
        allFilteredFiles.sort((a, b) => {
          switch (sortBy) {
            case "newest":
              return new Date(b.created_at) - new Date(a.created_at);
            case "oldest":
              return new Date(a.created_at) - new Date(b.created_at);
            case "name":
              return a.name.localeCompare(b.name);
            case "size":
              return b.size - a.size;
            default:
              return 0;
          }
        });

        totalFilteredFiles = allFilteredFiles.length;

        // Fix currentPage BEFORE slicing (prevent invalid page numbers)
        const totalPages = Math.max(
          1,
          Math.ceil(totalFilteredFiles / pageSize)
        );
        if (currentPage > totalPages) {
          currentPage = totalPages;
        }

        // Slice for current page display only
        const startIndex = (currentPage - 1) * pageSize;
        const endIndex = startIndex + pageSize;
        filteredFiles = allFilteredFiles.slice(startIndex, endIndex);

        renderPagination();
        renderMediaGrid();
      }

      // Render media grid
      function renderMediaGrid() {
        const grid = document.getElementById("mediaGrid");
        const loading = document.getElementById("loadingState");
        const empty = document.getElementById("emptyState");
        const selectionMode = isSelectionMode();

        // Show/hide selection mode banner
        const banner = document.getElementById('selection-mode-banner');
        if (selectionMode && banner) {
          banner.classList.remove('hidden');
          document.getElementById('selection-context').textContent = `Select a file for ${getSelectionContext()}`;
        } else if (banner) {
          banner.classList.add('hidden');
        }

        loading.classList.add("hidden");

        if (filteredFiles.length === 0) {
          grid.classList.add("hidden");
          empty.classList.remove("hidden");
          document.getElementById("fileCount").textContent = "0 files";
          return;
        }

        empty.classList.add("hidden");
        grid.classList.remove("hidden");

        grid.innerHTML = filteredFiles
          .map(
            (file) => `
          <div class="media-item ${
            selectedFiles.has(file.id) ? "selected" : ""
          }" data-file-id="${file.id}" ${selectionMode ? `onclick="selectMediaFile('${file.name}', ${file.isImage}, ${file.isVideo})"` : ''}>
            <!-- Checkbox overlay or Selection button -->
            ${selectionMode ? `
              <div class="absolute inset-x-0 bottom-0 p-2 bg-gradient-to-t from-black/60 to-transparent">
                <button 
                  onclick="selectMediaFile('${file.name}', ${file.isImage}, ${file.isVideo}); event.stopPropagation();"
                  class="w-full px-3 py-2 bg-emerald-600 text-white rounded hover:bg-emerald-700 transition-colors font-medium text-sm flex items-center justify-center gap-2"
                >
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                  </svg>
                  Select
                </button>
              </div>
            ` : `
            <div class="absolute top-2 left-2 z-10">
              <input 
                type="checkbox" 
                class="media-checkbox w-5 h-5 text-emerald-600 rounded border-2 border-white shadow-lg focus:ring-2 focus:ring-emerald-500 cursor-pointer"
                data-file-id="${file.id}"
                ${selectedFiles.has(file.id) ? "checked" : ""}
                onclick="event.stopPropagation()"
              />
            </div>
            `}
            ${
              file.isVideo
                ? `
              <video src="${
                file.thumbUrl || file.url
              }" class="w-full h-full object-contain" 
                     preload="metadata" muted playsinline></video>
              <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                <div class="bg-black/60 rounded-full p-3">
                  <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M8 5v14l11-7z"/>
                  </svg>
                </div>
              </div>
            `
                : `
              <img src="${file.thumbUrl || file.url}" alt="${
                    file.name
                  }" class="w-full h-full object-contain" 
                   loading="lazy"
                   onload="console.log('‚úÖ Image loaded:', '${file.name}')"
                   onerror="console.log('‚ùå Image failed:', '${
                     file.name
                   }'); this.style.display='none'; this.nextElementSibling.style.display='flex';" />
              <div class="absolute inset-0 flex items-center justify-center bg-gray-200" style="display:none;">
                <div class="text-center text-gray-500">
                  <svg class="w-12 h-12 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                  </svg>
                  <p class="text-sm">Image failed to load</p>
                </div>
              </div>
            `
            }
            <div class="media-overlay">
              <div class="media-actions">
                <button
                  class="p-1 bg-white bg-opacity-20 rounded text-white hover:bg-opacity-30"
                  onclick="copyUrl('${file.url}')"
                  title="Copy URL"
                >
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                  </svg>
                </button>
                <button
                  class="p-1 bg-white bg-opacity-20 rounded text-white hover:bg-opacity-30"
                  onclick="deleteFile('${file.id}')"
                  title="Delete"
                >
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                  </svg>
                </button>
              </div>
              <div class="media-info">
                <div class="font-medium truncate">${file.name}</div>
                <div class="text-xs opacity-75">${formatFileSize(
                  file.size
                )}</div>
              </div>
            </div>
          </div>
        `
          )
          .join("");

        document.getElementById(
          "fileCount"
        ).textContent = `${totalFilteredFiles} files`;

        // Add click handlers for selection
        grid.querySelectorAll(".media-item").forEach((item, index) => {
          item.addEventListener("click", (e) => {
            if (e.target.closest("button")) return;
            if (e.target.closest(".media-checkbox")) return; // Don't open viewer if clicking checkbox

            const fileId = item.dataset.fileId;

            if (e.shiftKey || e.metaKey || e.ctrlKey) {
              if (selectedFiles.has(fileId)) {
                selectedFiles.delete(fileId);
                item.classList.remove("selected");
              } else {
                selectedFiles.add(fileId);
                item.classList.add("selected");
              }
              updateSelectionUI();
              return;
            }

            // Find index in ALL filtered files, not just current page
            const globalIndex = allFilteredFiles.findIndex(
              (f) => f.id === fileId
            );
            openViewer(globalIndex);
          });
        });

        // Add checkbox click handlers
        grid.querySelectorAll(".media-checkbox").forEach((checkbox) => {
          checkbox.addEventListener("change", (e) => {
            e.stopPropagation();
            const fileId = checkbox.dataset.fileId;
            const item = checkbox.closest(".media-item");

            if (checkbox.checked) {
              selectedFiles.add(fileId);
              item.classList.add("selected");
            } else {
              selectedFiles.delete(fileId);
              item.classList.remove("selected");
            }

            updateSelectionUI();
          });
        });

        // Call preload for visible images
        preloadVisibleImages();
      }

      // Update selection UI (toolbar, count, select all checkbox)
      function updateSelectionUI() {
        const toolbar = document.getElementById("selectionToolbar");
        const selectedCount = document.getElementById("selectedCount");
        const selectAllCheckbox = document.getElementById("selectAllCheckbox");

        // Show/hide toolbar based on selection
        if (selectedFiles.size > 0) {
          toolbar?.classList.remove("hidden");
        } else {
          toolbar?.classList.add("hidden");
        }

        // Update selected count
        if (selectedCount) {
          selectedCount.textContent = selectedFiles.size;
        }

        // Update select all checkbox state
        if (selectAllCheckbox) {
          const allSelected =
            filteredFiles.length > 0 &&
            filteredFiles.every((f) => selectedFiles.has(f.id));
          const someSelected = filteredFiles.some((f) =>
            selectedFiles.has(f.id)
          );

          selectAllCheckbox.checked = allSelected;
          selectAllCheckbox.indeterminate = someSelected && !allSelected;
        }
      }

      // Empty state helper
      function showEmptyState() {
        document.getElementById("loadingState").classList.add("hidden");
        document.getElementById("mediaGrid").classList.add("hidden");
        document.getElementById("emptyState").classList.remove("hidden");
      }

      // Drag & drop handlers
      function handleDragOver(e) {
        e.preventDefault();
        if (e.dataTransfer) e.dataTransfer.dropEffect = "copy";
        e.currentTarget.classList.add("dragover");
      }

      function handleDragLeave(e) {
        e.preventDefault();
        e.currentTarget.classList.remove("dragover");
      }

      function handleDrop(e) {
        e.preventDefault();
        e.currentTarget.classList.remove("dragover");
        const files = e.dataTransfer.files;
        handleFiles(files);
      }

      function handleFileSelect(e) {
        const files = e.target.files;
        handleFiles(files);
      }

      function renderPagination() {
        const paginationContainer =
          document.getElementById("paginationControls");

        if (!paginationContainer) return;

        const totalPages = Math.max(
          1,
          Math.ceil(totalFilteredFiles / pageSize)
        );

        const startIndex =
          totalFilteredFiles === 0 ? 0 : (currentPage - 1) * pageSize + 1;
        const endIndex = Math.min(currentPage * pageSize, totalFilteredFiles);

        paginationContainer.innerHTML = `
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div class="flex items-center gap-4">
              <div class="flex items-center gap-2">
                <label class="text-sm text-gray-700">Items per page:</label>
                <select
                  id="pageSizeSelect"
                  class="px-3 py-1 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                >
                  <option value="10" ${
                    pageSize === 10 ? "selected" : ""
                  }>10</option>
                  <option value="20" ${
                    pageSize === 20 ? "selected" : ""
                  }>20</option>
                  <option value="50" ${
                    pageSize === 50 ? "selected" : ""
                  }>50</option>
                  <option value="100" ${
                    pageSize === 100 ? "selected" : ""
                  }>100</option>
                </select>
              </div>
              <div class="flex items-center gap-2">
                <label class="text-sm text-gray-700">Jump to:</label>
                <input
                  type="number"
                  id="pageJumpInput"
                  min="1"
                  max="${totalPages}"
                  value="${currentPage}"
                  class="w-16 px-2 py-1 border border-gray-300 rounded-lg text-center focus:ring-2 focus:ring-emerald-500"
                />
                <button
                  id="pageJumpBtn"
                  class="px-3 py-1 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 text-sm"
                >
                  Go
                </button>
              </div>
            </div>
            <div class="flex items-center gap-4">
              <span class="text-sm text-gray-700">Showing ${startIndex}-${endIndex} of ${totalFilteredFiles}</span>
              <div class="flex gap-2">
                <button
                  class="px-3 py-1 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-100 ${
                    currentPage === 1 ? "opacity-50 pointer-events-none" : ""
                  }"
                  data-page="prev"
                >
                  Previous
                </button>
                <button
                  class="px-3 py-1 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-100 ${
                    currentPage === totalPages
                      ? "opacity-50 pointer-events-none"
                      : ""
                  }"
                  data-page="next"
                >
                  Next
                </button>
              </div>
            </div>
          </div>
        `;

        const prevBtn = paginationContainer.querySelector(
          'button[data-page="prev"]'
        );
        const nextBtn = paginationContainer.querySelector(
          'button[data-page="next"]'
        );
        const newPageSizeSelect =
          paginationContainer.querySelector("#pageSizeSelect");
        const pageJumpBtn = paginationContainer.querySelector("#pageJumpBtn");

        if (prevBtn) {
          prevBtn.addEventListener("click", () => {
            if (currentPage > 1) {
              currentPage--;
              filterFiles();
            }
          });
        }

        if (nextBtn) {
          nextBtn.addEventListener("click", () => {
            const totalPages = Math.max(
              1,
              Math.ceil(totalFilteredFiles / pageSize)
            );
            if (currentPage < totalPages) {
              currentPage++;
              filterFiles();
            }
          });
        }

        if (newPageSizeSelect) {
          newPageSizeSelect.addEventListener("change", (event) => {
            const newSize = parseInt(event.target.value, 10) || 20;
            pageSize = newSize;
            currentPage = 1;
            filterFiles();
          });
        }

        if (pageJumpBtn) {
          pageJumpBtn.addEventListener("click", () => {
            const input = paginationContainer.querySelector("#pageJumpInput");
            const pageNum = parseInt(input.value);
            const totalPages = Math.max(
              1,
              Math.ceil(totalFilteredFiles / pageSize)
            );
            if (pageNum >= 1 && pageNum <= totalPages) {
              currentPage = pageNum;
              filterFiles();
            }
          });
        }
      }

      // Global variables for naming modal and pagination
      let pendingFiles = [];
      let currentFileIndex = 0;
      let batchSelectedName = "";
      let pageSize = 20;
      let currentPage = 1;

      async function handleFiles(files) {
        pendingFiles = Array.from(files);
        currentFileIndex = 0;
        batchSelectedName = "";

        if (pendingFiles.length > 0) {
          showNamingModal(pendingFiles[0]);
        }
      }

      // Show naming modal for a file
      function showNamingModal(file) {
        const modal = document.getElementById("namingModal");
        const originalFileName = document.getElementById("originalFileName");
        const finalFileName = document.getElementById("finalFileName");

        // Show original filename
        originalFileName.textContent = file.name;

        // Reset form
        document.getElementById("nameDropdown").value = "";
        document.getElementById("customNameInput").value = "";
        document.getElementById("customNameContainer").classList.add("hidden");

        // Update final filename preview
        updateFinalFileName(file);

        resetUploadProgress();

        // Show modal
        modal.classList.remove("hidden");
        modal.classList.remove("opacity-0");
        modal.classList.add("opacity-100");
      }

      // Update final filename preview
      function updateFinalFileName(file) {
        const dropdown = document.getElementById("nameDropdown");
        const customInput = document.getElementById("customNameInput");
        const finalFileName = document.getElementById("finalFileName");

        let baseName = "";

        if (dropdown.value === "custom") {
          baseName = customInput.value.trim();
        } else if (dropdown.value) {
          baseName = dropdown.value;
        }

        if (baseName) {
          const ext = file.name.split(".").pop().toLowerCase();
          const cleanName = baseName
            .replace(/[^a-zA-Z0-9-_]/g, "-")
            .toLowerCase();
          finalFileName.textContent = `${cleanName}.${ext}`;
        } else {
          finalFileName.textContent = "Select a name...";
        }
      }

      // Close naming modal
      function closeNamingModal() {
        const modal = document.getElementById("namingModal");
        modal.classList.add("hidden");
        modal.classList.remove("opacity-100");
        modal.classList.add("opacity-0");

        // Clear pending files
        pendingFiles = [];
        currentFileIndex = 0;

        resetUploadProgress();
      }

      async function processBatchUpload(nameChoice) {
        const total = pendingFiles.length;
        failedUploads = [];

        for (
          let index = currentFileIndex;
          index < pendingFiles.length;
          index++
        ) {
          const file = pendingFiles[index];
          updateUploadProgress(index, total, file.name);
          const success = await uploadFileWithName(file, nameChoice);
          if (!success) {
            failedUploads.push(file.name);
          }
          currentFileIndex = index + 1;
        }

        if (failedUploads.length > 0) {
          openUploadErrorModal(failedUploads);
        }
      }

      function updateUploadProgress(index, total, fileName) {
        if (!progressElements.container) return;

        const displayName =
          fileName.length > 40 ? `${fileName.slice(0, 37)}...` : fileName;
        const completed = index + 1;
        const percent = Math.round((completed / total) * 100);

        progressElements.text.textContent = `Uploading ${completed} of ${total}: ${displayName}`;
        progressElements.bar.style.width = `${percent}%`;
      }

      function resetUploadProgress() {
        if (!progressElements.container) return;
        progressElements.container.classList.add("hidden");
        if (progressElements.text) progressElements.text.textContent = "";
        if (progressElements.bar) progressElements.bar.style.width = "0%";
      }

      // Upload file with custom name
      async function uploadFileWithName(file, customName) {
        try {
          const ext = (file.name.split(".").pop() || "bin").toLowerCase();
          let fileName;

          if (customName) {
            // Clean the custom name
            const cleanName = customName
              .replace(/[^a-zA-Z0-9-_]/g, "-")
              .toLowerCase();
            fileName = `${cleanName}.${ext}`;

            // Check if file already exists and add timestamp if needed
            const { data: existingFiles } = await supabase.storage
              .from("media")
              .list("", { search: fileName });

            if (existingFiles && existingFiles.length > 0) {
              const timestamp = Date.now();
              fileName = `${cleanName}-${timestamp}.${ext}`;
            }
          } else {
            // Fallback to timestamp naming
            const timestamp = Date.now();
            fileName = `media-${timestamp}.${ext}`;
          }

          const success = await attemptUploadWithRetry(fileName, file, 2);
          if (!success) {
            console.error("Upload failed after retries:", fileName);
            return false;
          }

          console.log(`Uploaded: ${fileName}`);
          return true;
        } catch (error) {
          console.error("Upload error:", error);
          return false;
        }
      }

      async function attemptUploadWithRetry(fileName, file, maxAttempts = 2) {
        let attempt = 0;
        while (attempt < maxAttempts) {
          const { error } = await supabase.storage
            .from("media")
            .upload(fileName, file, { cacheControl: "3600", upsert: false });

          if (!error) {
            return true;
          }

          console.warn(
            `Upload attempt ${attempt + 1} failed for ${fileName}:`,
            error
          );
          attempt++;

          if (attempt < maxAttempts) {
            await new Promise((resolve) => setTimeout(resolve, 500));
          }
        }

        return false;
      }

      function openUploadErrorModal(failedList) {
        const modal = document.getElementById("uploadErrorModal");
        const list = document.getElementById("uploadErrorList");
        if (!modal || !list) return;

        list.innerHTML = failedList
          .map(
            (name) => `
            <div class="px-4 py-3 bg-white">
              <p class="text-sm font-medium text-gray-800">${name}</p>
              <p class="text-xs text-gray-500">Upload failed after retry</p>
            </div>
          `
          )
          .join("");

        modal.classList.remove("hidden");
        modal.classList.remove("opacity-0");
        modal.classList.add("opacity-100");
      }

      function closeUploadErrorModal() {
        const modal = document.getElementById("uploadErrorModal");
        if (!modal) return;
        modal.classList.add("hidden");
        modal.classList.remove("opacity-100");
        modal.classList.add("opacity-0");
      }

      // Clean up orphaned media entries
      async function cleanupOrphanedFiles() {
        try {
          console.log("üßπ Cleaning up orphaned files...");

          // Force refresh from storage
          const { data, error } = await supabase.storage
            .from("media")
            .list("", {
              limit: 100,
              offset: 0,
            });

          if (error) throw error;

          console.log(`üìÅ Storage bucket contains ${data.length} actual files`);

          // Clear current media files array
          mediaFiles = [];

          // Reload with fresh data
          await loadMediaFiles();

          console.log("‚úÖ Cleanup complete - media files refreshed");
        } catch (error) {
          console.error("‚ùå Cleanup failed:", error);
          alert("Failed to cleanup orphaned files. Please refresh the page.");
        }
      }

      // Legacy upload function - now handled by uploadFileWithName

      // Utils used by grid
      function formatFileSize(bytes) {
        if (bytes === 0) return "0 Bytes";
        const k = 1024;
        const sizes = ["Bytes", "KB", "MB", "GB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
      }

      function copyUrl(url) {
        navigator.clipboard.writeText(url).then(() => {
          alert("URL copied to clipboard!");
        });
      }

      // Delete actions (open custom modal)
      window.deleteFile = function (fileId) {
        openDeleteModal([fileId]);
      };

      async function deleteSelectedFiles() {
        if (selectedFiles.size === 0) return;
        openDeleteModal(Array.from(selectedFiles));
      }

      function openDeleteModal(ids) {
        if (!deleteModalElements.container) return;
        const files = ids
          .map(
            (id) =>
              allFilteredFiles.find((f) => f.id === id) ||
              mediaFiles.find((f) => f.id === id)
          )
          .filter(Boolean);
        if (files.length === 0) return;

        pendingDelete = { ids, files };
        deleteModalElements.title.textContent =
          files.length > 1
            ? `Delete ${files.length} files?`
            : `Delete "${files[0].name}"?`;
        deleteModalElements.detail.textContent =
          files.length > 1
            ? "These files will be permanently removed from storage. This action cannot be undone."
            : "This file will be permanently removed from storage. This action cannot be undone.";

        deleteModalElements.list.innerHTML = files
          .slice(0, 3)
          .map(
            (file) => `
          <div class="flex items-center gap-3 rounded-xl border border-gray-200 px-3 py-2">
            <div class="h-12 w-12 flex-shrink-0 overflow-hidden rounded-lg border border-gray-100">
              <img src="${file.url}" alt="${
              file.name
            }" class="h-full w-full object-cover" />
            </div>
            <div class="flex-1">
              <p class="text-sm font-medium text-gray-900 truncate">${
                file.name
              }</p>
              <p class="text-xs text-gray-500">${formatFileSize(file.size)}</p>
            </div>
          </div>
        `
          )
          .join("");

        if (files.length > 3) {
          deleteModalElements.extraCount.textContent = `+ ${
            files.length - 3
          } more files`;
          deleteModalElements.extraCount.classList.remove("hidden");
        } else {
          deleteModalElements.extraCount.classList.add("hidden");
        }

        openOverlay(deleteModalElements.container);
      }

      function closeDeleteModal() {
        if (!deleteModalElements.container) return;
        closeOverlay(deleteModalElements.container);
        pendingDelete = null;
      }

      async function confirmDelete() {
        if (!pendingDelete) return;
        const ids = pendingDelete.ids;
        pendingDelete = null;
        closeOverlay(deleteModalElements.container);
        await processDeletions(ids);
      }

      async function processDeletions(ids) {
        // Show deletion progress modal
        const progressModal = document.getElementById("deletionProgressModal");
        const progressText = document.getElementById("deletionProgressText");
        const progressBar = document.getElementById("deletionProgressBar");

        if (progressModal) {
          progressModal.classList.remove("hidden");
          progressModal.classList.add("opacity-100");
          progressModal.classList.remove("opacity-0");
        }

        const total = ids.length;
        let completed = 0;

        for (const fileId of ids) {
          try {
            const file = mediaFiles.find((f) => f.id === fileId);

            // Update progress text
            if (progressText && file) {
              const displayName =
                file.name.length > 30
                  ? `${file.name.slice(0, 27)}...`
                  : file.name;
              progressText.textContent = `Deleting ${
                completed + 1
              } of ${total}: ${displayName}`;
            }

            if (fileId.startsWith("sample-")) {
              mediaFiles = mediaFiles.filter((f) => f.id !== fileId);
              allFilteredFiles = allFilteredFiles.filter(
                (f) => f.id !== fileId
              );
              filteredFiles = filteredFiles.filter((f) => f.id !== fileId);
              selectedFiles.delete(fileId);
            } else {
              if (!file) continue;
              const { error } = await supabase.storage
                .from("media")
                .remove([file.name]);
              if (error) throw error;

              // Remove from all arrays
              mediaFiles = mediaFiles.filter((f) => f.id !== fileId);
              allFilteredFiles = allFilteredFiles.filter(
                (f) => f.id !== fileId
              );
              filteredFiles = filteredFiles.filter((f) => f.id !== fileId);
              selectedFiles.delete(fileId);
            }

            // Update progress
            completed++;
            const percent = Math.round((completed / total) * 100);
            if (progressBar) {
              progressBar.style.width = `${percent}%`;
            }

            // Update grid dynamically after each deletion
            renderMediaGrid();
            updateSelectionUI();

            // Small delay for visual feedback
            await new Promise((resolve) => setTimeout(resolve, 200));
          } catch (error) {
            console.error("Delete error:", error);

            // Close progress modal
            if (progressModal) {
              progressModal.classList.add("opacity-0");
              progressModal.classList.remove("opacity-100");
              setTimeout(() => progressModal.classList.add("hidden"), 200);
            }

            alert(`Failed to delete "${file?.name}". Please try again.`);
            break;
          }
        }

        // Close progress modal
        if (progressModal) {
          if (progressText) {
            progressText.textContent = `Successfully deleted ${completed} files!`;
          }
          await new Promise((resolve) => setTimeout(resolve, 500));
          progressModal.classList.add("opacity-0");
          progressModal.classList.remove("opacity-100");
          setTimeout(() => {
            progressModal.classList.add("hidden");
            if (progressBar) progressBar.style.width = "0%";
          }, 200);
        }

        // Final grid update
        renderMediaGrid();
        updateSelectionUI();

        // Handle viewer if open
        if (viewerIndex >= 0) {
          if (allFilteredFiles[viewerIndex]) updateViewerContent();
          else closeViewer();
        }
      }

      // Viewer helpers
      function openViewer(index) {
        if (!viewerElements.container) return;
        viewerIndex = index;
        updateViewerContent();
        openOverlay(viewerElements.container, { lockScroll: true });
      }

      function updateViewerContent() {
        if (viewerIndex < 0 || !allFilteredFiles[viewerIndex]) return;
        const file = allFilteredFiles[viewerIndex];

        if (file.isVideo) {
          // Show video, hide image
          viewerElements.image.classList.add("hidden");
          viewerElements.video.classList.remove("hidden");
          viewerElements.video.src = file.url;
          viewerElements.video.load();
        } else {
          // Show image, hide video
          viewerElements.video.classList.add("hidden");
          viewerElements.image.classList.remove("hidden");
          viewerElements.image.src = file.url;
          viewerElements.image.alt = file.name;
        }

        viewerElements.title.textContent = file.name;
        viewerElements.meta.textContent = `${formatFileSize(
          file.size
        )} ‚Ä¢ ${new Date(file.created_at).toLocaleString()}`;
        viewerElements.prevBtn.disabled = viewerIndex === 0;
        viewerElements.nextBtn.disabled =
          viewerIndex === allFilteredFiles.length - 1;
      }

      function navigateViewer(delta) {
        const next = viewerIndex + delta;
        if (next < 0 || next >= allFilteredFiles.length) return;

        // Stop any currently playing video before navigating
        if (viewerElements.video && !viewerElements.video.paused) {
          viewerElements.video.pause();
        }

        viewerIndex = next;
        updateViewerContent();
      }

      function closeViewer() {
        // Stop any currently playing video before closing
        if (viewerElements.video && !viewerElements.video.paused) {
          viewerElements.video.pause();
        }

        viewerIndex = -1;
        if (viewerElements.container) closeOverlay(viewerElements.container);
      }

      function handleGlobalKeydown(e) {
        if (overlayDepth === 0) return;
        if (e.key === "Escape") {
          if (pendingDelete) closeDeleteModal();
          else if (viewerIndex >= 0) closeViewer();
        }
        if (viewerIndex >= 0) {
          if (e.key === "ArrowRight") navigateViewer(1);
          else if (e.key === "ArrowLeft") navigateViewer(-1);
        }
      }

      // Overlay helpers
      function openOverlay(el, options = {}) {
        if (!el || overlayHandlers.has(el)) return;
        overlayHandlers.add(el);
        overlayDepth += 1;
        el.classList.remove("hidden");
        requestAnimationFrame(() => {
          el.classList.add("opacity-100");
          el.classList.remove("opacity-0");
        });
        if (options.lockScroll) document.body.style.overflow = "hidden";
      }

      function closeOverlay(el) {
        if (!el || !overlayHandlers.has(el)) return;
        overlayHandlers.delete(el);
        overlayDepth = Math.max(overlayDepth - 1, 0);
        el.classList.add("opacity-0");
        el.classList.remove("opacity-100");
        setTimeout(() => {
          if (!overlayHandlers.has(el)) el.classList.add("hidden");
        }, 200);
        if (overlayDepth === 0) document.body.style.overflow = "";
      }

      // Ensure listeners are bound even if DOMContentLoaded has already fired
      try {
        ensureEventListeners();
      } catch (e) {
        console.warn("Media: ensureEventListeners failed initially", e);
      }

      // ========================================
      // Media Selection Functions (for Hero Backgrounds)
      // ========================================

      // Check if in selection mode
      function isSelectionMode() {
        const params = new URLSearchParams(window.location.search);
        return params.get('mode') === 'select';
      }

      // Get selection context
      function getSelectionContext() {
        const params = new URLSearchParams(window.location.search);
        return params.get('context') || 'hero background';
      }

      // Cancel media selection
      function cancelMediaSelection() {
        window.close();
        // If window.close() doesn't work (not opened by script), go back
        if (!window.closed) {
          window.history.back();
        }
      }

      // Select media file
      function selectMediaFile(fileName, isImage, isVideo) {
        const publicUrl = `${supabase.supabaseUrl}/storage/v1/object/public/media/${fileName}`;
        const mediaType = isImage ? 'image' : (isVideo ? 'video' : 'unknown');

        // If opened from site-settings, use callback
        if (window.opener && window.opener.handleMediaSelection) {
          window.opener.handleMediaSelection(publicUrl, mediaType, fileName);
          window.close();
        } else {
          // Fallback: store in sessionStorage and close
          sessionStorage.setItem('selectedMedia', JSON.stringify({
            url: publicUrl,
            type: mediaType,
            name: fileName
          }));
          alert(`Selected: ${fileName}\n\nPlease refresh the Site Settings page to see the selected media.`);
          window.close();
        }
      }

      // Make selection functions globally available
      window.cancelMediaSelection = cancelMediaSelection;
      window.selectMediaFile = selectMediaFile;

      // Note: Logout button is handled by shared/navigation.js
    </script>
  </body>
</html>
