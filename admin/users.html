<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>User Management - Dog Bar Admin</title>

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="../assets/media/logo.png?v=2" />

    <!-- Compiled Tailwind CSS -->
    <link rel="stylesheet" href="../assets/css/tailwind.output.css" />
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script type="module" src="shared/theme-manager.js"></script>
    <script type="module" src="shared/logger.js"></script>
    <script type="module" src="shared/permissions.js"></script>
    <script type="module" src="shared/navigation.js"></script>
  </head>
  <body class="bg-white dark:bg-gray-900 min-h-screen transition-colors">
    <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
      <!-- Page Header -->
      <div class="px-4 py-6 sm:px-0">
        <div class="flex justify-between items-center mb-6">
          <div>
            <h2 class="text-2xl font-bold text-gray-900 dark:text-white transition-colors">User Management</h2>
            <p class="text-gray-600 dark:text-gray-400 transition-colors">
              Manage admin accounts, staff, and customer memberships
            </p>
          </div>
          <button
            id="createUserBtn"
            class="bg-emerald-600 text-white px-4 py-2 rounded-lg hover:bg-emerald-700 transition-colors"
          >
            Create New Account
          </button>
        </div>

        <!-- User Type Tabs -->
        <div class="border-b border-gray-200 mb-6">
          <nav class="-mb-px flex space-x-8">
            <button
              id="adminTab"
              class="py-2 px-1 border-b-2 border-emerald-500 text-emerald-600 font-medium text-sm"
            >
              Admin Users
            </button>
            <button
              id="customerTab"
              class="py-2 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm"
            >
              Customer Memberships
            </button>
          </nav>
        </div>

        <!-- Admin Users Section -->
        <div id="adminUsersSection" class="space-y-4">
          <div class="bg-white dark:bg-gray-800 shadow rounded-lg transition-colors">
            <div class="px-6 py-4 border-b border-gray-200">
              <h3 class="text-lg font-medium text-gray-900 dark:text-white transition-colors">Admin Accounts</h3>
              <p class="text-sm text-gray-600">
                Manage staff and admin access levels
              </p>
              
              <!-- Filter and Search -->
              <div class="flex flex-wrap items-center gap-4 mt-4">
                <div class="flex-1 min-w-[200px]">
                  <input
                    type="text"
                    id="adminSearch"
                    placeholder="Search by name or email..."
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                  />
                </div>
                <div class="flex items-center gap-2">
                  <label class="text-sm text-gray-700">Filter:</label>
                  <select id="adminRoleFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                    <option value="all">All Roles</option>
                    <option value="super_admin">Super Admin</option>
                    <option value="admin">Admin</option>
                    <option value="manager">Manager</option>
                    <option value="staff">Staff</option>
                  </select>
                  <select id="adminStatusFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                    <option value="all">All Status</option>
                    <option value="active">Active</option>
                    <option value="inactive">Inactive</option>
                    <option value="suspended">Suspended</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Pagination Controls (Top) -->
            <div class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 px-6 py-4 transition-colors">
              <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <div class="flex items-center gap-4">
                  <div class="flex items-center gap-2">
                    <label class="text-sm text-gray-700">Items per page:</label>
                    <select id="adminPageSize" class="px-3 py-1 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                      <option value="10" selected>10</option>
                      <option value="20">20</option>
                      <option value="50">50</option>
                      <option value="100">100</option>
                    </select>
                  </div>
                  <div class="flex items-center gap-2">
                    <label class="text-sm text-gray-700">Jump to:</label>
                    <input
                      type="number"
                      id="adminPageJumpInput"
                      min="1"
                      class="w-16 px-2 py-1 border border-gray-300 rounded-lg text-center focus:ring-2 focus:ring-emerald-500"
                    />
                    <button
                      id="adminPageJumpBtn"
                      class="px-3 py-1 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 text-sm"
                    >
                      Go
                    </button>
                  </div>
                </div>
                <div class="flex items-center gap-4">
                  <span id="adminPageInfo" class="text-sm text-gray-700">Showing 1-10 of 100</span>
                  <div class="flex gap-2">
                    <button id="adminPrevPage" class="px-3 py-1 border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">Previous</button>
                    <button id="adminNextPage" class="px-3 py-1 border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">Next</button>
                  </div>
                </div>
              </div>
            </div>

            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                      onclick="sortAdminTable('full_name')"
                    >
                      Name <span id="sort-full_name" class="text-gray-400">↕</span>
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                      onclick="sortAdminTable('email')"
                    >
                      Email <span id="sort-email" class="text-gray-400">↕</span>
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                      onclick="sortAdminTable('role')"
                    >
                      Role <span id="sort-role" class="text-gray-400">↕</span>
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                      onclick="sortAdminTable('status')"
                    >
                      Status <span id="sort-status" class="text-gray-400">↕</span>
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                      onclick="sortAdminTable('last_login')"
                    >
                      Last Login <span id="sort-last_login" class="text-gray-400">↕</span>
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                    >
                      Actions
                    </th>
                  </tr>
                </thead>
                <tbody
                  id="adminUsersTable"
                  class="bg-white dark:bg-gray-900 divide-y divide-gray-200 dark:divide-gray-700 transition-colors"
                >
                  <!-- Admin users will be loaded here -->
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Customer Memberships Section -->
        <div id="customerMembershipsSection" class="space-y-4 hidden">
          <div class="bg-white dark:bg-gray-800 shadow rounded-lg transition-colors">
            <div class="px-6 py-4 border-b border-gray-200">
              <h3 class="text-lg font-medium text-gray-900 dark:text-white transition-colors">
                Customer Memberships
              </h3>
              <p class="text-sm text-gray-600">
                Manage customer accounts and membership status
              </p>
              
              <!-- Filter and Search -->
              <div class="flex flex-wrap items-center gap-4 mt-4">
                <div class="flex-1 min-w-[200px]">
                  <input
                    type="text"
                    id="customerSearch"
                    placeholder="Search by name or email..."
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                  />
                </div>
                <div class="flex items-center gap-2">
                  <label class="text-sm text-gray-700">Filter:</label>
                  <select id="customerMembershipFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                    <option value="all">All Memberships</option>
                    <option value="basic">Basic</option>
                    <option value="premium">Premium</option>
                    <option value="vip">VIP</option>
                  </select>
                  <select id="customerStatusFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                    <option value="all">All Status</option>
                    <option value="active">Active</option>
                    <option value="inactive">Inactive</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Pagination Controls (Top) -->
            <div class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 px-6 py-4 transition-colors">
              <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <div class="flex items-center gap-4">
                  <div class="flex items-center gap-2">
                    <label class="text-sm text-gray-700">Items per page:</label>
                    <select id="customerPageSize" class="px-3 py-1 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                      <option value="10" selected>10</option>
                      <option value="20">20</option>
                      <option value="50">50</option>
                      <option value="100">100</option>
                    </select>
                  </div>
                  <div class="flex items-center gap-2">
                    <label class="text-sm text-gray-700">Jump to:</label>
                    <input
                      type="number"
                      id="customerPageJumpInput"
                      min="1"
                      class="w-16 px-2 py-1 border border-gray-300 rounded-lg text-center focus:ring-2 focus:ring-emerald-500"
                    />
                    <button
                      id="customerPageJumpBtn"
                      class="px-3 py-1 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 text-sm"
                    >
                      Go
                    </button>
                  </div>
                </div>
                <div class="flex items-center gap-4">
                  <span id="customerPageInfo" class="text-sm text-gray-700">Showing 1-10 of 100</span>
                  <div class="flex gap-2">
                    <button id="customerPrevPage" class="px-3 py-1 border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">Previous</button>
                    <button id="customerNextPage" class="px-3 py-1 border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">Next</button>
                  </div>
                </div>
              </div>
            </div>

            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                      onclick="sortCustomerTable('full_name')"
                    >
                      Name <span id="sort-customer-full_name" class="text-gray-400">↕</span>
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                      onclick="sortCustomerTable('email')"
                    >
                      Email <span id="sort-customer-email" class="text-gray-400">↕</span>
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                      onclick="sortCustomerTable('phone')"
                    >
                      Phone <span id="sort-customer-phone" class="text-gray-400">↕</span>
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                      onclick="sortCustomerTable('membership_type')"
                    >
                      Membership <span id="sort-customer-membership_type" class="text-gray-400">↕</span>
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                      onclick="sortCustomerTable('membership_status')"
                    >
                      Status <span id="sort-customer-membership_status" class="text-gray-400">↕</span>
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                      onclick="sortCustomerTable('membership_expires')"
                    >
                      Expires <span id="sort-customer-membership_expires" class="text-gray-400">↕</span>
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                    >
                      Actions
                    </th>
                  </tr>
                </thead>
                <tbody
                  id="customerMembershipsTable"
                  class="bg-white dark:bg-gray-900 divide-y divide-gray-200 dark:divide-gray-700 transition-colors"
                >
                  <!-- Customer memberships will be loaded here -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Create/Edit User Modal -->
    <div
      id="userModal"
      class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50"
    >
      <div
        class="relative top-20 mx-auto p-5 border border-gray-300 dark:border-gray-700 w-96 shadow-lg rounded-md bg-white dark:bg-gray-800 transition-colors"
      >
        <div class="mt-3">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-medium text-gray-900" id="modalTitle">
              Create New Account
            </h3>
            <button id="closeModal" class="text-gray-400 hover:text-gray-600">
              <svg
                class="w-6 h-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                ></path>
              </svg>
            </button>
          </div>

          <form id="userForm">
            <div class="space-y-4">
              <!-- Account Type -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2"
                  >Account Type</label
                >
                <select
                  id="userType"
                  name="userType"
                  class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-600 rounded-lg shadow-sm bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 focus:bg-white dark:focus:bg-gray-600 transition-colors"
                >
                  <option value="admin">Admin User</option>
                  <option value="customer">Customer Membership</option>
                </select>
              </div>

              <!-- Basic Info -->
              <div class="border-t border-gray-200 pt-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Basic Information</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2"
                    >First Name</label
                  >
                  <input
                    type="text"
                    id="firstName"
                    name="firstName"
                    required
                    class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-600 rounded-lg shadow-sm bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 focus:bg-white dark:focus:bg-gray-600 transition-colors"
                    placeholder="Enter first name"
                  />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2"
                    >Last Name</label
                  >
                  <input
                    type="text"
                    id="lastName"
                    name="lastName"
                    class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-600 rounded-lg shadow-sm bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 focus:bg-white dark:focus:bg-gray-600 transition-colors"
                    placeholder="Enter last name"
                  />
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2"
                  >Full Name</label
                >
                <input
                  type="text"
                  id="fullName"
                  name="fullName"
                  class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-600 rounded-lg shadow-sm bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 focus:bg-white dark:focus:bg-gray-600 transition-colors"
                  placeholder="Auto-filled from first + last name"
                />
                <p class="text-xs text-gray-500 mt-2">
                  Auto-filled from first + last name, or enter manually
                </p>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2"
                    >Email</label
                  >
                  <input
                    type="email"
                    id="email"
                    name="email"
                    required
                    class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-600 rounded-lg shadow-sm bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 focus:bg-white dark:focus:bg-gray-600 transition-colors"
                    placeholder="user@example.com"
                  />
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2"
                    >Phone</label
                  >
                  <input
                    type="tel"
                    id="phone"
                    name="phone"
                    class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-600 rounded-lg shadow-sm bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 focus:bg-white dark:focus:bg-gray-600 transition-colors"
                    placeholder="(555) 123-4567"
                  />
                </div>
              </div>

              <!-- Admin-specific fields -->
              <div id="adminFields" class="border-t border-gray-200 pt-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Admin Details</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2"
                      >Department</label
                    >
                    <input
                      type="text"
                      id="department"
                      name="department"
                      placeholder="e.g., IT, Operations, Management"
                      class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-600 rounded-lg shadow-sm bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 focus:bg-white dark:focus:bg-gray-600 transition-colors"
                    />
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2"
                      >Job Title</label
                    >
                    <input
                      type="text"
                      id="jobTitle"
                      name="jobTitle"
                      placeholder="e.g., System Administrator, Manager"
                      class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-600 rounded-lg shadow-sm bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 focus:bg-white dark:focus:bg-gray-600 transition-colors"
                    />
                  </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2"
                      >Hire Date</label
                    >
                    <input
                      type="date"
                      id="hireDate"
                      name="hireDate"
                      class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-600 rounded-lg shadow-sm bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 focus:bg-white dark:focus:bg-gray-600 transition-colors"
                    />
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2"
                      >Last Login</label
                    >
                    <input
                      type="datetime-local"
                      id="lastLogin"
                      name="lastLogin"
                      readonly
                      class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg shadow-sm bg-gray-100 text-gray-600"
                    />
                    <p class="text-xs text-gray-500 mt-2">
                      Automatically updated on login
                    </p>
                  </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2"
                      >Login Count</label
                    >
                    <input
                      type="number"
                      id="loginCount"
                      name="loginCount"
                      min="0"
                      readonly
                      class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg shadow-sm bg-gray-100 text-gray-600"
                    />
                    <p class="text-xs text-gray-500 mt-2">
                      Automatically incremented on login
                    </p>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2"
                      >Email Verified</label
                    >
                    <select
                      id="emailVerified"
                      name="emailVerified"
                      class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-600 rounded-lg shadow-sm bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 focus:bg-white dark:focus:bg-gray-600 transition-colors"
                    >
                      <option value="true">Yes</option>
                      <option value="false">No</option>
                    </select>
                  </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2"
                      >Two-Factor Auth</label
                    >
                    <select
                      id="twoFactorEnabled"
                      name="twoFactorEnabled"
                      class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-600 rounded-lg shadow-sm bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 focus:bg-white dark:focus:bg-gray-600 transition-colors"
                    >
                      <option value="false">Disabled</option>
                      <option value="true">Enabled</option>
                    </select>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2"
                      >Password Reset Token</label
                    >
                    <input
                      type="text"
                      id="passwordResetToken"
                      name="passwordResetToken"
                      readonly
                      class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg shadow-sm bg-gray-100 text-gray-600"
                    />
                    <p class="text-xs text-gray-500 mt-2">
                      Auto-generated for password resets
                    </p>
                  </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2 flex items-center space-x-2">
                      <span>Role</span>
                      <span class="relative group">
                        <svg class="w-4 h-4 text-gray-400 group-hover:text-gray-600" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
                          <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.732-1A3 3 0 1110 7a1 1 0 100 2 1 1 0 010 2 1 1 0 100 2 1 1 0 110 2 1 1 0 100-2 1 1 0 110-2 1 1 0 110-2z" clip-rule="evenodd" />
                        </svg>
                        <div class="absolute z-10 hidden group-hover:block bg-white border border-gray-200 rounded-md shadow-lg p-3 w-64 text-xs text-gray-700 -left-2 mt-2">
                          <div class="font-semibold mb-1">Role permissions</div>
                          <ul class="list-disc pl-4 space-y-1">
                            <li><span class="font-medium">Super Admin</span>: Full access to all admin pages and settings.</li>
                            <li><span class="font-medium">Admin</span>: Manage events, media, food trucks, and customers.</li>
                            <li><span class="font-medium">Manager</span>: Manage events and media; limited admin functions.</li>
                            <li><span class="font-medium">Staff</span>: Basic operational access; create/edit content only.</li>
                          </ul>
                        </div>
                      </span>
                    </label>
                    <select
                      id="role"
                      name="role"
                      class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-600 rounded-lg shadow-sm bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 focus:bg-white dark:focus:bg-gray-600 transition-colors"
                    >
                      <option value="staff" selected>Staff</option>
                      <option value="admin">Admin</option>
                      <option value="super_admin">Super Admin</option>
                      <option value="manager">Manager</option>
                    </select>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2"
                      >Status</label
                    >
                    <select
                      id="admin-status"
                      name="status"
                      class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-600 rounded-lg shadow-sm bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 focus:bg-white dark:focus:bg-gray-600 transition-colors"
                    >
                      <option value="active">Active</option>
                      <option value="inactive">Inactive</option>
                      <option value="suspended">Suspended</option>
                    </select>
                  </div>
                </div>

                <div class="border-t border-gray-200 pt-6">
                  <h4 class="text-md font-medium text-gray-900 mb-4">Security & Notes</h4>
                  
                  <div class="space-y-4">
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-2"
                        >Password</label
                      >
                      <input
                        type="password"
                        id="password"
                        name="password"
                        class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-600 rounded-lg shadow-sm bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 focus:bg-white dark:focus:bg-gray-600 transition-colors"
                        placeholder="Enter new password"
                      />
                      <p class="text-xs text-gray-500 mt-2">
                        Leave blank to keep current password
                      </p>
                    </div>

                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-2"
                        >Notes</label
                      >
                      <textarea
                        id="notes"
                        name="notes"
                        rows="3"
                        placeholder="Additional notes about this admin user..."
                        class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg shadow-sm bg-gray-50 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 focus:bg-white transition-colors resize-none"
                      ></textarea>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Customer-specific fields -->
              <div id="customerFields" class="hidden">
                <div>
                  <label class="block text-sm font-medium text-gray-700"
                    >Membership Type</label
                  >
                  <select
                    id="membershipType"
                    name="membershipType"
                    class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500"
                  >
                    <option value="basic">Basic ($25/month)</option>
                    <option value="premium">Premium ($45/month)</option>
                    <option value="vip">VIP ($75/month)</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700"
                    >Dog Name</label
                  >
                  <input
                    type="text"
                    id="dogName"
                    name="dogName"
                    class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500"
                  />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700"
                    >Dog Breed</label
                  >
                  <input
                    type="text"
                    id="dogBreed"
                    name="dogBreed"
                    class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500"
                  />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700"
                    >Membership Expires</label
                  >
                  <input
                    type="date"
                    id="membershipExpires"
                    name="membershipExpires"
                    class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500"
                  />
                </div>
              </div>

              <!-- Status -->
              <div>
                <label class="block text-sm font-medium text-gray-700"
                  >Status</label
                >
                <select
                  id="customer-status"
                  name="status"
                  class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500"
                >
                  <option value="active">Active</option>
                  <option value="inactive">Inactive</option>
                  <option value="suspended">Suspended</option>
                </select>
              </div>
            </div>

            <div class="flex justify-end space-x-3 mt-6">
              <button
                type="button"
                id="cancelBtn"
                class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50"
              >
                Cancel
              </button>
              <button
                type="submit"
                class="px-4 py-2 bg-emerald-600 text-white rounded-md hover:bg-emerald-700"
              >
                Save User
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script>
      // Supabase configuration
      const supabaseUrl = "https://pkomfbezaollhvcpezaw.supabase.co";
      const supabaseKey =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBrb21mYmV6YW9sbGh2Y3BlemF3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4NjcxMTIsImV4cCI6MjA3NTQ0MzExMn0.E2__i0ieMKMYwx-bzk3rnZ9-ozQLSJxMIm3GhRKt8K0";
      const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

      let currentUser = null;
      let editingUserId = null;
      let editingUserType = null; // 'admin' or 'customer'
      
      // Pagination state
      let adminPage = 0;
      let adminPageSize = 10;
      let adminTotalCount = 0;
      let customerPage = 0;
      let customerPageSize = 10;
      let customerTotalCount = 0;
      
      // Filtering and sorting state
      let adminSearchQuery = "";
      let adminRoleFilter = "all";
      let adminStatusFilter = "all";
      let adminSortColumn = "created_at";
      let adminSortDirection = false; // false = desc, true = asc
      
      let customerSearchQuery = "";
      let customerMembershipFilter = "all";
      let customerStatusFilter = "all";
      let customerSortColumn = "created_at";
      let customerSortDirection = false;

      // Auto-populate full name from first + last name
      function setupNameAutoFill() {
        const firstNameField = document.getElementById("firstName");
        const lastNameField = document.getElementById("lastName");
        const fullNameField = document.getElementById("fullName");

        function updateFullName() {
          const firstName = firstNameField.value.trim();
          const lastName = lastNameField.value.trim();
          const fullName = [firstName, lastName].filter(Boolean).join(" ");
          fullNameField.value = fullName;
        }

        if (firstNameField && lastNameField && fullNameField) {
          firstNameField.addEventListener("input", updateFullName);
          lastNameField.addEventListener("input", updateFullName);
        }
      }

      // Initialize page
      document.addEventListener("DOMContentLoaded", function () {
        checkAuth();
        setupEventListeners();
        loadAdminUsers();
        setupNameAutoFill();
      });

      // Check authentication
      async function checkAuth() {
        const token = localStorage.getItem("supabase.auth.token");
        if (!token) {
          window.location.href = "login.html";
          return;
        }

        try {
          const {
            data: { user },
            error,
          } = await supabase.auth.getUser();
          if (error || !user) {
            window.location.href = "login.html";
            return;
          }

          currentUser = user;
          document.getElementById("userEmail").textContent = user.email;

          // Wait for PermissionManager to be initialized
          let attempts = 0;
          const maxAttempts = 10;

          while (
            !window.PermissionManager ||
            !window.PermissionManager.userRole
          ) {
            if (attempts >= maxAttempts) {
              console.warn(
                "⚠️ PermissionManager not ready after waiting, continuing anyway..."
              );
              break;
            }
            await new Promise((resolve) => setTimeout(resolve, 100));
            attempts++;
          }

          // Check if user has permission to access this page
          console.log("🔍 Checking manage_users permission...");
          console.log(
            "🔍 PermissionManager role:",
            window.PermissionManager.userRole
          );
          console.log(
            "🔍 Has manage_users permission:",
            window.PermissionManager.hasPermission("manage_users")
          );

          if (!window.PermissionManager.hasPermission("manage_users")) {
            console.log("❌ Access denied - no manage_users permission");
            alert("You do not have permission to access this page.");
            window.location.href = "dashboard.html";
            return;
          }

          console.log("✅ Access granted - user has manage_users permission");
        } catch (error) {
          console.error("Auth check failed:", error);
          window.location.href = "login.html";
        }
      }

      // Setup event listeners
      function setupEventListeners() {
        // Tab switching
        const adminTab = document.getElementById("adminTab");
        const customerTab = document.getElementById("customerTab");
        const createUserBtn = document.getElementById("createUserBtn");
        const closeModal = document.getElementById("closeModal");
        const cancelBtn = document.getElementById("cancelBtn");

        if (adminTab) {
          adminTab.addEventListener("click", () => switchTab("admin"));
        }
        if (customerTab) {
          customerTab.addEventListener("click", () => switchTab("customer"));
        }
        if (createUserBtn) {
          createUserBtn.addEventListener("click", () => openUserModal());
        }
        if (closeModal) {
          closeModal.addEventListener("click", closeUserModal);
        }
        if (cancelBtn) {
          cancelBtn.addEventListener("click", closeUserModal);
        }

        // User type change
        const userType = document.getElementById("userType");
        const userForm = document.getElementById("userForm");
        const logoutBtn = document.getElementById("logoutBtn");

        if (userType) {
          userType.addEventListener("change", toggleUserTypeFields);
        }
        if (userForm) {
          userForm.addEventListener("submit", handleUserSubmit);
        }
        if (logoutBtn) {
          logoutBtn.addEventListener("click", logout);
        }
        
        // Admin pagination
        const adminPageSizeSelect = document.getElementById("adminPageSize");
        const adminPrevBtn = document.getElementById("adminPrevPage");
        const adminNextBtn = document.getElementById("adminNextPage");
        
        if (adminPageSizeSelect) {
          adminPageSizeSelect.addEventListener("change", (e) => {
            adminPageSize = parseInt(e.target.value);
            adminPage = 0; // Reset to first page
            loadAdminUsers();
          });
        }
        if (adminPrevBtn) {
          adminPrevBtn.addEventListener("click", () => {
            if (adminPage > 0) {
              adminPage--;
              loadAdminUsers();
            }
          });
        }
        if (adminNextBtn) {
          adminNextBtn.addEventListener("click", () => {
            if ((adminPage + 1) * adminPageSize < adminTotalCount) {
              adminPage++;
              loadAdminUsers();
            }
          });
        }
        
        // Admin page jump
        const adminPageJumpBtn = document.getElementById('adminPageJumpBtn');
        if (adminPageJumpBtn) {
          adminPageJumpBtn.addEventListener('click', () => {
            const input = document.getElementById('adminPageJumpInput');
            const pageNum = parseInt(input.value);
            const totalPages = Math.ceil(adminTotalCount / adminPageSize);
            if (pageNum >= 1 && pageNum <= totalPages) {
              adminPage = pageNum - 1;
              loadAdminUsers();
            }
          });
        }
        
        // Customer pagination
        const customerPageSizeSelect = document.getElementById("customerPageSize");
        const customerPrevBtn = document.getElementById("customerPrevPage");
        const customerNextBtn = document.getElementById("customerNextPage");
        
        if (customerPageSizeSelect) {
          customerPageSizeSelect.addEventListener("change", (e) => {
            customerPageSize = parseInt(e.target.value);
            customerPage = 0; // Reset to first page
            loadCustomerMemberships();
          });
        }
        if (customerPrevBtn) {
          customerPrevBtn.addEventListener("click", () => {
            if (customerPage > 0) {
              customerPage--;
              loadCustomerMemberships();
            }
          });
        }
        if (customerNextBtn) {
          customerNextBtn.addEventListener("click", () => {
            if ((customerPage + 1) * customerPageSize < customerTotalCount) {
              customerPage++;
              loadCustomerMemberships();
            }
          });
        }
        
        // Customer page jump
        const customerPageJumpBtn = document.getElementById('customerPageJumpBtn');
        if (customerPageJumpBtn) {
          customerPageJumpBtn.addEventListener('click', () => {
            const input = document.getElementById('customerPageJumpInput');
            const pageNum = parseInt(input.value);
            const totalPages = Math.ceil(customerTotalCount / customerPageSize);
            if (pageNum >= 1 && pageNum <= totalPages) {
              customerPage = pageNum - 1;
              loadCustomerMemberships();
            }
          });
        }
        
        // Admin search and filters
        const adminSearch = document.getElementById("adminSearch");
        const adminRoleFilterSelect = document.getElementById("adminRoleFilter");
        const adminStatusFilterSelect = document.getElementById("adminStatusFilter");
        
        if (adminSearch) {
          let searchTimeout;
          adminSearch.addEventListener("input", (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
              adminSearchQuery = e.target.value.trim();
              adminPage = 0;
              loadAdminUsers();
            }, 300); // Debounce search
          });
        }
        if (adminRoleFilterSelect) {
          adminRoleFilterSelect.addEventListener("change", (e) => {
            adminRoleFilter = e.target.value;
            adminPage = 0;
            loadAdminUsers();
          });
        }
        if (adminStatusFilterSelect) {
          adminStatusFilterSelect.addEventListener("change", (e) => {
            adminStatusFilter = e.target.value;
            adminPage = 0;
            loadAdminUsers();
          });
        }
        
        // Customer search and filters
        const customerSearch = document.getElementById("customerSearch");
        const customerMembershipFilterSelect = document.getElementById("customerMembershipFilter");
        const customerStatusFilterSelect = document.getElementById("customerStatusFilter");
        
        if (customerSearch) {
          let searchTimeout;
          customerSearch.addEventListener("input", (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
              customerSearchQuery = e.target.value.trim();
              customerPage = 0;
              loadCustomerMemberships();
            }, 300);
          });
        }
        if (customerMembershipFilterSelect) {
          customerMembershipFilterSelect.addEventListener("change", (e) => {
            customerMembershipFilter = e.target.value;
            customerPage = 0;
            loadCustomerMemberships();
          });
        }
        if (customerStatusFilterSelect) {
          customerStatusFilterSelect.addEventListener("change", (e) => {
            customerStatusFilter = e.target.value;
            customerPage = 0;
            loadCustomerMemberships();
          });
        }
      }

      // Switch between admin and customer tabs
      function switchTab(tab) {
        const adminTab = document.getElementById("adminTab");
        const customerTab = document.getElementById("customerTab");
        const adminSection = document.getElementById("adminUsersSection");
        const customerSection = document.getElementById(
          "customerMembershipsSection"
        );

        if (tab === "admin") {
          adminTab.classList.add("border-emerald-500", "text-emerald-600");
          adminTab.classList.remove("border-transparent", "text-gray-500");
          customerTab.classList.add("border-transparent", "text-gray-500");
          customerTab.classList.remove(
            "border-emerald-500",
            "text-emerald-600"
          );
          adminSection.classList.remove("hidden");
          customerSection.classList.add("hidden");
        } else {
          customerTab.classList.add("border-emerald-500", "text-emerald-600");
          customerTab.classList.remove("border-transparent", "text-gray-500");
          adminTab.classList.add("border-transparent", "text-gray-500");
          adminTab.classList.remove("border-emerald-500", "text-emerald-600");
          customerSection.classList.remove("hidden");
          adminSection.classList.add("hidden");
          loadCustomerMemberships();
        }
      }

      // Toggle fields based on Account Type
      function toggleUserTypeFields() {
        const userType = document.getElementById("userType").value; // admin | customer
        const adminFields = document.getElementById("adminFields");
        const customerFields = document.getElementById("customerFields");

        if (userType === "admin") {
          adminFields.classList.remove("hidden");
          customerFields.classList.add("hidden");
        } else {
          adminFields.classList.add("hidden");
          customerFields.classList.remove("hidden");
        }
      }

      // Load admin users
      async function loadAdminUsers() {
        try {
          // Build query with filters
          let query = supabase.from("admin_users").select("*", { count: "exact" });
          let countQuery = supabase.from("admin_users").select("*", { count: "exact", head: true });
          
          // Apply filters
          if (adminRoleFilter !== "all") {
            query = query.eq("role", adminRoleFilter);
            countQuery = countQuery.eq("role", adminRoleFilter);
          }
          if (adminStatusFilter !== "all") {
            query = query.eq("status", adminStatusFilter);
            countQuery = countQuery.eq("status", adminStatusFilter);
          }
          if (adminSearchQuery) {
            query = query.or(`full_name.ilike.%${adminSearchQuery}%,email.ilike.%${adminSearchQuery}%`);
            countQuery = countQuery.or(`full_name.ilike.%${adminSearchQuery}%,email.ilike.%${adminSearchQuery}%`);
          }
          
          // Get total count with filters
          const { count } = await countQuery;
          adminTotalCount = count || 0;
          
          // Apply sorting and pagination
          const from = adminPage * adminPageSize;
          const to = from + adminPageSize - 1;
          
          let { data, error } = await query
            .order(adminSortColumn, { ascending: adminSortDirection })
            .range(from, to);

          if (error) throw error;

          const tbody = document.getElementById("adminUsersTable");
          tbody.innerHTML = "";

          if (data.length === 0) {
            tbody.innerHTML =
              '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">No admin users found</td></tr>';
            return;
          }

          data.forEach((user) => {
            const row = document.createElement("tr");
            row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                          <div class="flex flex-col">
                             <span>${
                               user.full_name ||
                               [user.first_name, user.last_name]
                                 .filter(Boolean)
                                 .join(" ") ||
                               "N/A"
                             }</span>
                            ${
                              user.job_title
                                ? `<span class="text-xs text-gray-500">${user.job_title}</span>`
                                : ""
                            }
                          </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                          <div class="flex flex-col">
                            <span>${user.email}</span>
                            ${
                              user.phone
                                ? `<span class="text-xs text-gray-400">${user.phone}</span>`
                                : ""
                            }
                          </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                              user.role === "super_admin"
                                ? "bg-purple-100 text-purple-800"
                                : user.role === "admin"
                                ? "bg-blue-100 text-blue-800"
                                : user.role === "manager"
                                ? "bg-green-100 text-green-800"
                                : user.role === "staff"
                                ? "bg-yellow-100 text-yellow-800"
                                : "bg-gray-100 text-gray-800"
                            }">
                                ${
                                  user.role === "super_admin"
                                    ? "Super Admin"
                                    : user.role === "admin"
                                    ? "Admin"
                                    : user.role === "manager"
                                    ? "Manager"
                                    : user.role === "staff"
                                    ? "Staff"
                                    : user.role || "Unknown"
                                }
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                              user.status === "active"
                                ? "bg-green-100 text-green-800"
                                : "bg-red-100 text-red-800"
                            }">
                                ${user.status || "active"}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                          <div class="flex flex-col">
                            <span>${
                              user.last_login
                                ? new Date(user.last_login).toLocaleDateString()
                                : "Never"
                            }</span>
                            ${
                              user.login_count
                                ? `<span class="text-xs text-gray-400">${user.login_count} logins</span>`
                                : ""
                            }
                          </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="editUser('${
                              user.id
                            }', 'admin')" class="text-emerald-600 hover:text-emerald-900 mr-3">Edit</button>
                            <button onclick="deleteUser('${
                              user.id
                            }')" class="text-red-600 hover:text-red-900">Delete</button>
                        </td>
                    `;
            tbody.appendChild(row);
          });
          
          // Update pagination UI
          updateAdminPagination();
        } catch (error) {
          console.error("Error loading admin users:", error);
          alert("Error loading admin users");
        }
      }
      
      // Update admin pagination UI
      function updateAdminPagination() {
        const totalPages = Math.ceil(adminTotalCount / adminPageSize);
        const from = adminPage * adminPageSize + 1;
        const to = Math.min((adminPage + 1) * adminPageSize, adminTotalCount);
        document.getElementById('adminPageInfo').textContent = 
          `Showing ${from}-${to} of ${adminTotalCount}`;
        
        document.getElementById('adminPrevPage').disabled = adminPage === 0;
        document.getElementById('adminNextPage').disabled = adminPage >= totalPages - 1;
        
        const jumpInput = document.getElementById('adminPageJumpInput');
        if (jumpInput) jumpInput.value = adminPage + 1;
      }

      // Load customer memberships
      async function loadCustomerMemberships() {
        try {
          // Build query with filters
          let query = supabase.from("customers").select("*", { count: "exact" });
          let countQuery = supabase.from("customers").select("*", { count: "exact", head: true });
          
          // Apply filters
          if (customerMembershipFilter !== "all") {
            query = query.eq("membership_type", customerMembershipFilter);
            countQuery = countQuery.eq("membership_type", customerMembershipFilter);
          }
          if (customerStatusFilter !== "all") {
            query = query.eq("membership_status", customerStatusFilter);
            countQuery = countQuery.eq("membership_status", customerStatusFilter);
          }
          if (customerSearchQuery) {
            query = query.or(`full_name.ilike.%${customerSearchQuery}%,email.ilike.%${customerSearchQuery}%`);
            countQuery = countQuery.or(`full_name.ilike.%${customerSearchQuery}%,email.ilike.%${customerSearchQuery}%`);
          }
          
          // Get total count with filters
          const { count } = await countQuery;
          customerTotalCount = count || 0;
          
          // Apply sorting and pagination
          const from = customerPage * customerPageSize;
          const to = from + customerPageSize - 1;
          
          const { data, error } = await query
            .order(customerSortColumn, { ascending: customerSortDirection })
            .range(from, to);

          if (error) throw error;

          const tbody = document.getElementById("customerMembershipsTable");
          tbody.innerHTML = "";

          if (data.length === 0) {
            tbody.innerHTML =
              '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">No customer memberships found</td></tr>';
            return;
          }

          data.forEach((customer) => {
            const row = document.createElement("tr");
            row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${
                          customer.full_name || "N/A"
                        }</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${
                          customer.email
                        }</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${
                          customer.phone || "N/A"
                        }</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${
                          customer.membership_type || "N/A"
                        }</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                              customer.membership_status === "active"
                                ? "bg-green-100 text-green-800"
                                : "bg-red-100 text-red-800"
                            }">
                                ${customer.membership_status || "active"}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${
                          customer.membership_expiry_date
                            ? new Date(
                                customer.membership_expiry_date
                              ).toLocaleDateString()
                            : "N/A"
                        }</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="editUser('${
                              customer.id
                            }', 'customer')" class="text-emerald-600 hover:text-emerald-900 mr-3">Edit</button>
                            <button onclick="deleteCustomer('${
                              customer.id
                            }')" class="text-red-600 hover:text-red-900">Delete</button>
                        </td>
                    `;
            tbody.appendChild(row);
          });
          
          // Update pagination UI
          updateCustomerPagination();
        } catch (error) {
          console.error("Error loading customer memberships:", error);
          alert("Error loading customer memberships");
        }
      }
      
      // Update customer pagination UI
      function updateCustomerPagination() {
        const totalPages = Math.ceil(customerTotalCount / customerPageSize);
        const from = customerPage * customerPageSize + 1;
        const to = Math.min((customerPage + 1) * customerPageSize, customerTotalCount);
        document.getElementById('customerPageInfo').textContent = 
          `Showing ${from}-${to} of ${customerTotalCount}`;
        
        document.getElementById('customerPrevPage').disabled = customerPage === 0;
        document.getElementById('customerNextPage').disabled = customerPage >= totalPages - 1;
        
        const jumpInput = document.getElementById('customerPageJumpInput');
        if (jumpInput) jumpInput.value = customerPage + 1;
      }
      
      // Sort admin table
      function sortAdminTable(column) {
        if (adminSortColumn === column) {
          adminSortDirection = !adminSortDirection;
        } else {
          adminSortColumn = column;
          adminSortDirection = true;
        }
        
        // Update sort indicators
        document.querySelectorAll('[id^="sort-"]').forEach(el => {
          if (el.id.startsWith('sort-customer-')) return;
          el.textContent = '↕';
          el.className = 'text-gray-400';
        });
        
        const indicator = document.getElementById(`sort-${column}`);
        if (indicator) {
          indicator.textContent = adminSortDirection ? '↑' : '↓';
          indicator.className = 'text-emerald-600';
        }
        
        adminPage = 0;
        loadAdminUsers();
      }
      
      // Sort customer table
      function sortCustomerTable(column) {
        if (customerSortColumn === column) {
          customerSortDirection = !customerSortDirection;
        } else {
          customerSortColumn = column;
          customerSortDirection = true;
        }
        
        // Update sort indicators
        document.querySelectorAll('[id^="sort-customer-"]').forEach(el => {
          el.textContent = '↕';
          el.className = 'text-gray-400';
        });
        
        const indicator = document.getElementById(`sort-customer-${column}`);
        if (indicator) {
          indicator.textContent = customerSortDirection ? '↑' : '↓';
          indicator.className = 'text-emerald-600';
        }
        
        customerPage = 0;
        loadCustomerMemberships();
      }

      // Open user modal
      async function openUserModal(userId = null) {
        editingUserId = userId;
        const modal = document.getElementById("userModal");
        const title = document.getElementById("modalTitle");

        if (userId) {
          title.textContent = "Edit User";
          // Show first to ensure inputs are in DOM, then populate
          modal.classList.remove("hidden");
          await loadUserData(userId);
          return;
        } else {
          title.textContent = "Create New Account";
          const form = document.getElementById("userForm");
          if (form) form.reset();
          toggleUserTypeFields();
        }

        modal.classList.remove("hidden");
      }

      // Close user modal
      function closeUserModal() {
        document.getElementById("userModal").classList.add("hidden");
        editingUserId = null;
      }

      // Load user data for editing
      async function loadUserData(userId) {
        try {
          // Determine which table to query based on editingUserType
          const tableName = editingUserType === 'customer' ? 'customers' : 'admin_users';
          
          const { data: user, error } = await supabase
            .from(tableName)
            .select("*")
            .eq("id", userId)
            .single();

          if (error) throw error;

          // Populate the form with user data
          const form = document.getElementById("userForm");
          if (form) {
            if (editingUserType === 'customer') {
              // Customer data
              form.firstName.value = user.full_name?.split(' ')[0] || "";
              form.lastName.value = user.full_name?.split(' ').slice(1).join(' ') || "";
              form.fullName.value = user.full_name || "";
              form.email.value = user.email || "";
              form.phone.value = user.phone || "";
              form.membershipType.value = user.membership_type || "basic";
              form.membershipExpires.value = user.membership_expires ? user.membership_expires.split("T")[0] : "";
              form.status.value = user.membership_status || "active";
              
              form.userType.value = "customer";
              toggleUserTypeFields();
            } else {
              // Admin user data
              form.firstName.value = user.first_name || "";
              form.lastName.value = user.last_name || "";
              form.fullName.value = user.full_name || "";
              form.email.value = user.email || "";
              form.phone.value = user.phone || "";
              
              // Admin-specific fields
              form.department.value = user.department || "";
              form.jobTitle.value = user.job_title || "";
              form.hireDate.value = user.hire_date
                ? user.hire_date.split("T")[0]
                : "";
              form.lastLogin.value = user.last_login
                ? new Date(user.last_login).toISOString().slice(0, 16)
                : "";
              form.loginCount.value = user.login_count || 0;
              form.emailVerified.value = user.email_verified ? "true" : "false";
              form.twoFactorEnabled.value = user.two_factor_enabled
                ? "true"
                : "false";
              form.passwordResetToken.value = user.password_reset_token || "";
              form.role.value = user.role || "staff";
              form.status.value = user.status || "active";
              form.notes.value = user.notes || "";

              form.userType.value = "admin";
              toggleUserTypeFields();
            }
          }
        } catch (error) {
          console.error("Error loading user data:", error);
          alert("Error loading user data");
        }
      }

      // Handle user form submission
      async function handleUserSubmit(e) {
        e.preventDefault();

        const formData = new FormData(e.target);
        const userType = formData.get("userType");

        try {
          if (userType === "admin") {
            await createOrUpdateAdminUser(formData);
          } else {
            await createOrUpdateCustomerMembership(formData);
          }

          closeUserModal();
          if (userType === "admin") {
            loadAdminUsers();
          } else {
            loadCustomerMemberships();
          }
        } catch (error) {
          console.error("Error saving user:", error);
          alert("Error saving user");
        }
      }

      // Create or update admin user
      async function createOrUpdateAdminUser(formData) {
        // Enforce: only super_admin can create a super_admin
        try {
          const { data: auth } = await supabase.auth.getUser();
          const currentEmail = auth?.user?.email || null;
          let currentRole = null;
          if (currentEmail) {
            const { data: me } = await supabase
              .from("admin_users")
              .select("role")
              .eq("email", currentEmail)
              .maybeSingle();
            currentRole = me?.role || null;
          }

          const requestedRole = formData.get("role") || "staff";
          if (requestedRole === "super_admin" && currentRole !== "super_admin") {
            alert("Only a Super Admin can create or promote a Super Admin.");
            return;
          }
        } catch (e) {
          console.warn("Could not verify current role; proceeding with caution", e);
        }

        const userData = {
          full_name: formData.get("fullName"),
          first_name: formData.get("firstName") || "",
          last_name: formData.get("lastName") || "",
          email: formData.get("email"),
          phone: formData.get("phone"),
          department: formData.get("department") || "",
          job_title: formData.get("jobTitle") || "",
          hire_date: formData.get("hireDate") || null,
          last_login: formData.get("lastLogin") || null,
          login_count: parseInt(formData.get("loginCount")) || 0,
          email_verified: formData.get("emailVerified") === "true",
          two_factor_enabled: formData.get("twoFactorEnabled") === "true",
          password_reset_token: formData.get("passwordResetToken") || null,
          role: formData.get("role") || "staff",
          status: formData.get("status"),
          notes: formData.get("notes") || "",
          updated_at: new Date().toISOString(),
        };

        if (editingUserId) {
          const { data: updated, error } = await supabase
            .from("admin_users")
            .update(userData)
            .eq("id", editingUserId)
            .select();
          if (error) throw error;
          if (!updated || updated.length === 0) {
            alert(
              "Update did not apply (0 rows). This is usually an RLS permission issue."
            );
          } else {
            const updatedUser = updated[0];
            window.auditLogger?.log("admin_user.updated", {
              user_id: updatedUser.id,
              email: updatedUser.email,
              role: updatedUser.role,
            });
            console.log("Updated admin user:", updated);
          }
        } else {
          // For now, just create in users table without Supabase Auth
          // The admin will need to set up their password separately
          userData.id = crypto.randomUUID();
          userData.created_at = new Date().toISOString();

          const { data: inserted, error: insertError } = await supabase
            .from("admin_users")
            .insert([userData])
            .select();
          if (insertError) throw insertError;

          const newAdmin = inserted?.[0];
          if (newAdmin?.id) {
            window.auditLogger?.log("admin_user.created", {
              user_id: newAdmin.id,
              email: newAdmin.email,
              role: newAdmin.role,
            });
          }
          console.log("Inserted admin user:", inserted);
        }
      }

      // Create or update customer membership
      async function createOrUpdateCustomerMembership(formData) {
        const customerData = {
          full_name: formData.get("fullName"),
          email: formData.get("email"),
          phone: formData.get("phone") || "",
          address: formData.get("address") || null,
          emergency_contact_name: formData.get("emergencyContactName") || null,
          emergency_contact_phone: formData.get("emergencyContactPhone") || null,
          membership_type: formData.get("membershipType"),
          membership_status: (formData.get("membershipStatus") || formData.get("status") || "active"),
          special_notes: formData.get("specialNotes") || null,
          updated_at: new Date().toISOString(),
        };

        // Only add membership_expires if provided (column may not exist yet)
        const expiryDate = formData.get("membershipExpires");
        if (expiryDate) {
          customerData.membership_expires = expiryDate;
        }

        if (editingUserId) {
          const { error } = await supabase
            .from("customers")
            .update(customerData)
            .eq("id", editingUserId);
          if (error) throw error;
        } else {
          customerData.id = crypto.randomUUID();
          customerData.created_at = new Date().toISOString();

          const { error: insertError } = await supabase
            .from("customers")
            .insert([customerData]);
          if (insertError) throw insertError;
        }
      }

      // Edit user
      function editUser(userId, type) {
        editingUserId = userId;
        editingUserType = type; // 'admin' or 'customer'
        openUserModal(userId);
      }

      // Delete user
      async function deleteUser(userId) {
        if (!confirm("Are you sure you want to delete this user?")) return;

        try {
          const { data: targetUser, error: fetchError } = await supabase
            .from("admin_users")
            .select("id, email, role")
            .eq("id", userId)
            .maybeSingle();

          if (fetchError) throw fetchError;

          const { error } = await supabase
            .from("admin_users")
            .delete()
            .eq("id", userId);
          if (error) throw error;

          if (targetUser?.id) {
            window.auditLogger?.log("admin_user.deleted", {
              user_id: targetUser.id,
              email: targetUser.email,
              role: targetUser.role,
            });
          }

          loadAdminUsers();
        } catch (error) {
          console.error("Error deleting user:", error);
          alert("Error deleting user");
        }
      }

      // Delete customer
      async function deleteCustomer(customerId) {
        if (
          !confirm(
            "Are you sure you want to delete this customer and all their data?"
          )
        )
          return;

        try {
          const { error } = await supabase
            .from("customers")
            .delete()
            .eq("id", customerId);
          if (error) throw error;

          loadCustomerMemberships();
        } catch (error) {
          console.error("Error deleting customer:", error);
          alert("Error deleting customer");
        }
      }

      // Logout
      async function logout() {
        await window.PermissionManager.logout();
      }
    </script>
  </body>
</html>
